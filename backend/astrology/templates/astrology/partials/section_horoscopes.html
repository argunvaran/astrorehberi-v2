<section id="view-horoscopes" class="view animate-in" style="display:none">
    <div style="text-align:center; margin-bottom:30px; animation:fadeIn 1s">
        <h1 style="font-family:'Cinzel'; font-size:2.5rem; color:var(--gold); margin-bottom:10px">Günlük Burç Yorumları
        </h1>
        <p style="opacity:0.7">Bugünün enerjileri burcunuz için neler söylüyor?</p>
    </div>

    <!-- HOROSCOPE GRID -->
    <!-- Unique ID to avoid conflicts -->
    <div id="daily-horo-grid-final"
        style="display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:20px; margin-bottom:40px; min-height:200px">
        <div style="opacity:0.5; text-align:center; padding:50px; grid-column:1/-1">
            <i class="fas fa-spinner fa-spin" style="font-size:2rem; margin-bottom:10px; display:block"></i>
            Yıldızlar hizalanıyor...
        </div>
    </div>

    <!-- INDEPENDENT MODAL FOR THIS SECTION -->
    <div id="horo-modal-standalone"
        style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; display:none; align-items:center; justify-content:center; backdrop-filter:blur(5px)"
        onclick="this.style.display='none'">
        <div class="glass-card animate-in"
            style="width:90%; max-width:600px; max-height:80vh; overflow-y:auto; position:relative; background:rgba(20,20,35,0.95); border:1px solid var(--accent); box-shadow:0 0 50px rgba(0,0,0,0.8)"
            onclick="event.stopPropagation()">
            <button onclick="document.getElementById('horo-modal-standalone').style.display='none'"
                style="position:absolute; top:15px; right:15px; background:none; border:none; color:white; font-size:1.5rem; cursor:pointer; z-index:10; opacity:0.7; transition:0.3s; padding:5px"
                onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">&times;</button>

            <div
                style="text-align:center; border-bottom:1px solid rgba(255,255,255,0.1); padding:25px 20px 15px 20px; margin-bottom:10px; background:linear-gradient(to bottom, rgba(233,69,96,0.1), transparent)">
                <h2 id="hms-modal-title"
                    style="color:var(--gold); margin:0; font-family:'Cinzel'; font-size:1.8rem; text-shadow:0 0 10px rgba(255,215,0,0.3)">
                </h2>
                <div style="font-size:0.9rem; opacity:0.6; margin-top:5px; color:var(--accent); font-family:'Outfit'; letter-spacing:1px"
                    id="hms-modal-date"></div>
            </div>

            <div id="hms-modal-content"
                style="line-height:1.8; font-size:1.15rem; color:rgba(255,255,255,0.9); padding:10px 30px 35px 30px; text-align:left; font-family:'Outfit'; white-space:pre-line">
            </div>
        </div>
    </div>
</section>

<script>
    // Global Loading State to prevent double-trigger loops
    window.horoLoading = false;

    // Define globally 
    window.loadHoroPage = async function () {
        if (window.horoLoading) {
            console.log("HoroPage is already loading...");
            return;
        }

        console.log("Global loadHoroPage triggered...");

        const grid = document.getElementById('daily-horo-grid-final');
        if (!grid) return;

        // Check if already populated (cache)
        if (grid.innerHTML.includes('class="glass-card"')) return;

        // Start Loading
        window.horoLoading = true;
        grid.style.opacity = '0.5';

        try {
            // Cache buster via timestamp
            const res = await fetch('/api/daily-horoscopes/?lang=tr&t=' + new Date().getTime());

            if (!res.ok) throw new Error("Network response was not ok");

            const data = await res.json();

            if (data.horoscopes && data.horoscopes.length > 0) {
                let html = "";
                data.horoscopes.forEach(h => {
                    html += `
                     <div onclick="window.openHoroModal('${h.sign} - Günlük Yorum', '${h.date}', '${h.text.replace(/'/g, "\\'")}')" 
                          class="glass-card"
                          style="cursor:pointer; transition:all 0.3s; border:1px solid rgba(255,255,255,0.1); background:linear-gradient(135deg, rgba(255,255,255,0.05), rgba(0,0,0,0.2)); text-align:left; padding:20px; position:relative; overflow:hidden"
                          onmouseover="this.style.transform='translateY(-5px)'; this.style.borderColor='var(--accent)'"
                          onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='rgba(255,255,255,0.1)'">
                         <div style="position:absolute; top:-10px; right:-10px; font-size:3rem; opacity:0.1; color:var(--accent)">${h.mood}</div>
                         <div style="display:flex; justify-content:space-between; align-items:center; position:relative; z-index:2">
                            <div>
                                <div style="font-size:1.3rem; font-weight:bold; color:var(--text); margin-bottom:5px; font-family:'Cinzel'">${h.sign}</div>
                                <div style="font-size:0.75rem; opacity:0.6; font-family:'Outfit'">${h.date} - Günlük Yorum</div>
                            </div>
                            <div style="font-size:1.8rem; filter:drop-shadow(0 0 5px var(--accent))">${h.mood}</div>
                         </div>
                     </div>`;
                });
                grid.innerHTML = html;
            } else {
                grid.innerHTML = '<div style="opacity:0.5; text-align:center; padding:20px; grid-column:1/-1">Yorum bulunamadı.</div>';
            }
        } catch (e) {
            console.error(e);
            grid.innerHTML = `<div style="opacity:0.8; text-align:center; color:#ff6666; cursor:pointer; grid-column:1/-1" onclick="window.loadHoroPage()">
                <i class="fas fa-redo"></i> Yükleme hatası. Tekrar dene.
             </div>`;
        } finally {
            // Unlock
            window.horoLoading = false;
            grid.style.opacity = '1';
        }
    };

    // Independent Modal Function
    window.openHoroModal = function (title, date, content) {
        document.getElementById('hms-modal-title').innerText = title;
        document.getElementById('hms-modal-date').innerText = date;
        document.getElementById('hms-modal-content').innerText = content;
        document.getElementById('horo-modal-standalone').style.display = 'flex';
    };

    // Auto-run attempt if visible (with small delay to allow DOM update)
    setTimeout(() => {
        const view = document.getElementById('view-horoscopes');
        if (view && view.style.display !== 'none') {
            window.loadHoroPage();
        }
    }, 500);
</script>