<section id="view-rectification" class="view animate-in" style="display:none">
    <style>
        /* Fix Select Options Visibility */
        .event-type option {
            background-color: #222;
            /* Dark background */
            color: #fff;
            /* White text */
            padding: 10px;
        }

        @media (prefers-color-scheme: light) {
            .event-type option {
                color: #000;
                background-color: #fff;
            }
        }

        .event-row {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        [data-theme="light"] .event-row {
            background: rgba(0, 0, 0, 0.03) !important;
            border: 1px solid rgba(0, 0, 0, 0.1) !important;
        }
    </style>

    <div style="text-align:center; margin-bottom:30px">
        <h1 style="font-family:'Cinzel'; font-size:2.5rem; color:var(--gold); margin-bottom:10px"
            data-i18n="rectify_title">REKTİFİKASYON</h1>
        <p style="opacity:0.7; font-size:1.1rem" data-i18n="rectify_subtitle">Profesyonel Doğum Saati Doğrulama</p>
    </div>

    <div class="glass-card" style="padding:40px; border:1px solid var(--accent)">
        <p
            style="margin-bottom:25px; line-height:1.7; font-size:1.05rem; background:rgba(255,255,255,0.05); padding:15px; border-radius:10px">
            <i class="fas fa-info-circle" style="color:var(--accent); margin-right:10px"></i>
            <span data-i18n="rectify_info">Doğum saatinizi tam olarak bilmiyorsanız, "Transitler" yöntemini kullanarak
                geriye dönük hesaplama yapabiliriz. Gezegenler hayatınızdaki önemli olaylar sırasında belirli
                konumlardaydı. Bu olayları harita açılarıyla eşleştirerek, en olası doğum saatini bulabiliriz.</span>
        </p>

        <h3 style="margin-bottom:15px; color:var(--accent); font-family:'Cinzel'"><i class="fas fa-calendar-alt"></i> 1.
            DOĞUM TARİHİNİ ONAYLA</h3>
        <div style="position:relative">
            <!-- Strict Date Picker -->
            <input type="date" id="rect-date" onclick="try{this.showPicker()}catch(e){}" onkeydown="return false"
                style="width:100%; padding:15px; background:rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2); border-radius:8px; color:var(--text); outline:none; font-family:'Outfit'; cursor:pointer">
            <style>
                input[type="date"]::-webkit-calendar-picker-indicator {
                    filter: invert(1);
                    cursor: pointer;
                    opacity: 0.8;
                }

                input[type="date"]::-webkit-calendar-picker-indicator:hover {
                    opacity: 1;
                    transform: scale(1.1);
                }
            </style>
        </div>

        <h3 style="margin:30px 0 15px 0; color:var(--accent); font-family:'Cinzel'"><i class="fas fa-history"></i> 2.
            ÖNEMLİ YAŞAM OLAYLARI</h3>
        <p style="font-size:0.95rem; margin-bottom:15px; opacity:0.8" data-i18n="rectify_ev_instr">Doğru sonuç için en
            az 3 önemli olay ekleyin (Evlilik, Çocuk Doğumu, Mezuniyet, Taşınma, Kayıp vb.)</p>

        <div id="event-list" style="display:flex; flex-direction:column; gap:10px">
            <!-- Content -->
        </div>

        <button class="btn"
            style="background:transparent; font-size:0.9rem; margin-top:15px; width:100%; border:1px dashed var(--border); color:var(--text)"
            onclick="addEventRow()" data-i18n="rectify_btn_add"><i class="fas fa-plus"></i> Yeni Olay Ekle</button>

        <div style="margin-top:40px; text-align:center">
            <button class="btn" onclick="startRectification()"
                style="padding:15px 50px; font-size:1.1rem; background:linear-gradient(45deg, var(--accent), #ff4081); font-weight:bold; border-radius:50px; box-shadow:0 5px 20px rgba(233,69,96,0.4)"
                data-i18n="rectify_btn_find"><i class="fas fa-search-location"></i> GERÇEK SAATİ BUL</button>
        </div>

        <div id="rect-overlay"
            style="display:none; margin-top:30px; color:var(--gold); text-align:center; background:rgba(0,0,0,0.4); padding:20px; border-radius:10px">
            <p data-i18n="rectify_scanning" style="font-size:1.2rem; margin-bottom:10px">24 saatlik döngü taranıyor (144
                olasılık)...</p>
            <i class="fas fa-satellite fa-spin" style="font-size:2.5rem; color:var(--accent)"></i>
        </div>
    </div>

    <div id="rect-results" style="display:none; margin-top:30px">
        <!-- Results -->
    </div>

    <!-- Custom Modal -->
    <div id="astro-modal"
        style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center; animation:fadeIn 0.3s; backdrop-filter:blur(5px)">
        <div class="glass-card animate-in-up"
            style="max-width:400px; text-align:center; padding:40px; border:1px solid var(--accent); box-shadow:0 0 50px rgba(233,69,96,0.4); background:linear-gradient(135deg, #1a1a2e, #16213e)">
            <i id="astro-modal-icon" class="fas fa-magic"
                style="font-size:3.5rem; color:var(--gold); margin-bottom:20px; filter:drop-shadow(0 0 15px var(--gold))"></i>
            <h3 id="astro-modal-title"
                style="color:white; margin-bottom:15px; font-family:'Cinzel'; font-size:1.5rem; letter-spacing:1px">
                UYARI</h3>
            <p id="astro-modal-msg"
                style="color:rgba(255,255,255,0.9); margin-bottom:30px; line-height:1.6; font-size:1.05rem"></p>
            <button class="btn" onclick="closeAstroModal()"
                style="background:var(--accent); width:100%; border-radius:30px; padding:15px; font-weight:bold; font-size:1.1rem; box-shadow:0 5px 15px rgba(233,69,96,0.5)">TAMAM</button>
        </div>
    </div>
</section>

<script>
    // --- MODAL LOGIC ---
    function showAstroModal(msg, title = 'UYARI', type = 'info') {
        const icon = document.getElementById('astro-modal-icon');
        const titleEl = document.getElementById('astro-modal-title');

        document.getElementById('astro-modal-msg').innerHTML = msg;
        titleEl.innerText = title;

        if (type === 'success') {
            icon.className = 'fas fa-check-circle';
            icon.style.color = '#4caf50';
            titleEl.style.color = '#4caf50';
        } else if (type === 'error') {
            icon.className = 'fas fa-exclamation-triangle';
            icon.style.color = '#ff6666';
            titleEl.style.color = '#ff6666';
        } else {
            icon.className = 'fas fa-info-circle';
            icon.style.color = 'var(--gold)';
            titleEl.style.color = 'var(--gold)';
        }

        document.getElementById('astro-modal').style.display = 'flex';
    }

    function closeAstroModal() {
        document.getElementById('astro-modal').style.display = 'none';
    }

    // RECTIFICATION LOGIC
    function toggleUnknownTime() {
        if (document.getElementById('unknown-time').checked) {
            nav('rectification');
            const mainDate = document.getElementById('date').value;
            if (mainDate) document.getElementById('rect-date').value = mainDate;

            const list = document.getElementById('event-list');
            if (list && list.children.length === 0) {
                addEventRow(); addEventRow(); addEventRow();
            }
            document.getElementById('unknown-time').checked = false;
        }
    }

    function addEventRow() {
        let options = `
            <option value="marriage">Evlilik</option>
            <option value="child_birth">Çocuk Doğumu</option>
            <option value="career_change">Kariyer Sıçraması (İş/Terfi)</option>
            <option value="relocation">Taşınma / Şehir Değişikliği</option>
            <option value="graduation">Mezuniyet</option>
            <option value="accident">Kaza / Ameliyat</option>
            <option value="loss">Vefat / Kayıp</option>
            <option value="award">Ödül / Başarı</option>
            <option value="education">Eğitim Başlangıç/Bitiş</option>
            <option value="travel">Uzun Seyahat</option>
        `;

        const div = document.createElement('div');
        div.className = 'event-row animate-in';
        div.style = 'display:flex; gap:15px; align-items:center; flex-wrap:wrap; padding:10px; border-radius:8px';
        div.innerHTML = `
            <div style="flex:1; min-width:150px">
                 <label style="font-size:0.7rem; display:block; margin-bottom:5px; opacity:0.6; color:var(--text-muted)">Olay Tipi</label>
                 <select class="glass-input event-type" style="width:100%; border:none; background:transparent; color:var(--text); font-size:1rem; padding:5px; cursor:pointer">
                   ${options}
                </select>
            </div>
            <div style="width:1px; height:30px; background:rgba(255,255,255,0.1)"></div>
            <div style="flex:1; min-width:150px">
                <label style="font-size:0.7rem; display:block; margin-bottom:5px; opacity:0.6; color:var(--text-muted)">Tarih</label>
                <input type="date" class="glass-input event-date" 
                       onclick="try{this.showPicker()}catch(e){}"
                       onkeydown="return false"
                       style="width:100%; border:none; background:transparent; color:var(--text); font-size:1rem; font-family:'Outfit'; padding:5px; cursor:pointer">
            </div>
            <i class="fas fa-times" onclick="this.parentElement.remove()" style="opacity:0.4; cursor:pointer; font-size:0.9rem; color:var(--text)" title="Kaldır"></i>
        `;
        document.getElementById('event-list').appendChild(div);
    }

    async function startRectification() {
        const resultsDiv = document.getElementById('rect-results');
        const loader = document.getElementById('rect-overlay');

        loader.style.display = 'block';
        resultsDiv.style.display = 'none';

        const date = document.getElementById('rect-date').value;
        const lat = document.getElementById('lat').value;
        const lon = document.getElementById('lon').value;

        const events = [];
        document.querySelectorAll('.event-row').forEach(row => {
            const type = row.querySelector('.event-type').value;
            const d = row.querySelector('.event-date').value;
            if (d && d.length > 5) events.push({ type, date: d });
        });

        // ERROR HANDLING WITH MODAL
        if (events.length === 0) {
            showAstroModal("Lütfen en az bir önemli olay ekleyin ve tarihini girin.", "Eksik Bilgi", "error");
            loader.style.display = 'none';
            return;
        }
        if (!date) {
            showAstroModal("Lütfen doğum tarihinizi seçin.<br>Tarih olmadan hesaplama yapılamaz.", "Tarih Seçilmedi", "error");
            loader.style.display = 'none';
            return;
        }

        try {
            const response = await fetch('/api/rectify-time/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, lat, lon, events, lang: 'tr' }) // Force TR
            });
            const data = await response.json();

            // CHECK PREMIUM LIMIT
            if (data.upgrade_required) {
                loader.style.display = 'none';
                if (typeof showUpgradeModal === 'function') {
                    showUpgradeModal(data.error);
                } else {
                    showAstroModal(data.error, "Premium Gerekli", "error");
                }
                return;
            }

            loader.style.display = 'none';
            resultsDiv.style.display = 'block';

            if (data.candidates && data.candidates.length > 0) {
                let html = `<h2 style="color:var(--gold); margin-bottom:25px; text-align:center; font-family:'Cinzel'"><i class="fas fa-award"></i> EN OLASI DOĞUM SAATLERİ</h2>`;

                data.candidates.forEach((c, index) => {
                    const isBest = index === 0;
                    html += `
                    <div class="glass-card animate-in" style="border-left: 5px solid ${isBest ? 'var(--gold)' : 'rgba(255,255,255,0.2)'}; padding:25px; margin-bottom:20px; background:${isBest ? 'linear-gradient(90deg, rgba(255,215,0,0.1), transparent)' : 'rgba(255,255,255,0.05)'}">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px">
                            <div>
                                <h3 style="font-size:2rem; font-weight:700; color:${isBest ? 'var(--gold)' : 'white'}">${c.time}</h3>
                                <div style="font-size:1.1rem; opacity:0.8">Yükselen: <strong>${c.asc_sign}</strong></div>
                            </div>
                            <div style="text-align:right">
                                <div style="background:var(--accent); padding:5px 15px; border-radius:20px; font-weight:bold; font-size:1.1rem">${c.score} Puan</div>
                                ${isBest ? '<div style="font-size:0.8rem; color:var(--gold); margin-top:5px">En Yüksek Olasılık %95</div>' : ''}
                            </div>
                        </div>
                        
                        <div style="background:rgba(0,0,0,0.2); padding:15px; border-radius:8px; font-size:0.95rem; line-height:1.6">
                            <strong style="color:var(--accent); display:block; margin-bottom:10px">Kanıtlar (Transit Eşleşmeleri):</strong>
                            <ul style="margin:0; padding-left:20px; opacity:0.9">
                                ${c.hits.slice(0, 5).map(h => `<li>${h.replace('Conjunction', 'Kavuşum').replace('trine', 'Üçgen').replace('Square', 'Kare').replace('Opposition', 'Karşıt')}</li>`).join('')}
                            </ul>
                        </div>

                        <button class="btn" style="margin-top:20px; width:100%; border-radius:30px; background:white; color:black; font-weight:bold" 
                            onclick="applyRectifiedTime('${c.time}')">
                            <i class="fas fa-check-circle" style="color:green"></i> BU SAATİ KULLAN
                        </button>
                    </div>`;
                });

                resultsDiv.innerHTML = html;
            } else {
                if (data.debug_error) {
                    showAstroModal(data.debug_error, "TEKNİK HATA RAPORU", "error");
                }
                resultsDiv.innerHTML = `<div class="glass-card" style="text-align:center; padding:30px">Uygun bir eşleşme bulunamadı. Lütfen olay tarihlerini kontrol edip tekrar deneyin.</div>`;
            }

        } catch (e) {
            console.error(e);
            loader.style.display = 'none';

            showAstroModal(`Bir hata oluştu: ${e}`, "HATA", "error");
        }
    }

    function applyRectifiedTime(time) {
        let rDate = document.getElementById('rect-date').value;
        const mainDate = document.getElementById('date').value;
        const finalDate = rDate || mainDate;
        const lat = document.getElementById('lat').value;
        const lon = document.getElementById('lon').value;

        // Ensure format is YYYY-MM-DD
        let formattedDate = finalDate;
        if (formattedDate) formattedDate = formattedDate.replace(/\//g, '-').replace(/\./g, '-');

        // CLEAR CACHE BEFORE SUBMIT
        sessionStorage.removeItem('astro_current_chart');
        localStorage.setItem('astro_saved_time', time);
        if (formattedDate) localStorage.setItem('astro_saved_date', formattedDate);

        // GUEST MODE: Just reload page (or Nav) if not auth
        // BUT wait, we don't have is_authenticated check easily here unless we rely on global var
        if (typeof SERVER_AUTH_STATUS !== 'undefined' && SERVER_AUTH_STATUS) {
            // STANDARD FORM POST (The "Old School" Reliable Way)
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/api/apply-rectification-form/';

            const fields = {
                'date': formattedDate,
                'time': time,
                'lat': lat,
                'lon': lon,
                'place': document.getElementById('rec-place')?.value || 'Unknown' // Pass place if available
            };

            for (const key in fields) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = fields[key];
                form.appendChild(input);
            }

            document.body.appendChild(form);
            form.submit();
        } else {
            // Guest Mode
            showAstroModal(`Doğum saatiniz <strong>${time}</strong> olarak ayarlandı. <br>Misafir modunda olduğunuz için bu ayar geçicidir.`, "SAAT GÜNCELLENDİ", "info");
            document.getElementById('time').value = time;
            if (formattedDate) document.getElementById('date').value = formattedDate;
            nav('chart');
            setTimeout(calcChart, 500);
        }
    }
</script>
```