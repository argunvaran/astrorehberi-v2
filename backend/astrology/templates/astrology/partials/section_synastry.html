<section id="view-synastry" class="view animate-in" style="display:none">
    <div style="text-align:center; margin-bottom:30px">
        <h1 style="font-family:'Cinzel'; font-size:2.5rem; color:var(--gold); margin-bottom:10px"
            data-i18n="menu_synastry">AÅK UYUMU</h1>
        <p style="opacity:0.7">Partnerinizle aranÄ±zdaki kozmik enerjiyi ve potansiyeli keÅŸfedin.</p>
    </div>

    <div class="glass-card" style="border:1px solid var(--accent); padding:30px; max-width:800px; margin:0 auto">

        <div
            style="display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:25px; margin-bottom:30px">

            <!-- User Date -->
            <div style="position:relative">
                <label style="display:block; margin-bottom:10px; opacity:0.9; font-size:0.95rem; color:var(--text)"><i
                        class="fas fa-user"></i> Sizin DoÄŸum Tarihiniz</label>
                <!-- Initial state: ReadOnly with placeholder. JS will try to fill it. If fail, it unlocks. -->
                <input type="date" id="syn-user-date" readonly
                    style="width:100%; padding:12px; background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); border-radius:8px; color:var(--text); font-family:'Outfit'; outline:none; cursor:not-allowed; transition:0.3s">
                <div id="syn-lock-msg" style="font-size:0.7rem; opacity:0.5; margin-top:5px; font-style:italic"><i
                        class="fas fa-lock"></i> Profilinizden otomatik alÄ±nÄ±r</div>
            </div>

            <!-- Partner Date -->
            <div>
                <label style="display:block; margin-bottom:10px; opacity:0.9; font-size:0.95rem; color:var(--text)"><i
                        class="fas fa-heart"></i> Partnerinizin DoÄŸum Tarihi</label>
                <input type="date" id="syn-partner-date" value="1995-02-14"
                    style="width:100%; padding:12px; background:rgba(0,0,0,0.3); border:1px solid var(--accent); border-radius:8px; color:var(--text); font-family:'Outfit'; outline:none; transition:0.3s"
                    onfocus="this.style.boxShadow='0 0 15px rgba(233,69,96,0.3)'" onblur="this.style.boxShadow='none'">
            </div>
        </div>

        <div style="text-align:center">
            <button class="btn" onclick="calcSynastry()"
                style="padding:15px 50px; background:linear-gradient(45deg, var(--accent), #ff4081); border:none; border-radius:50px; color:white; font-weight:bold; cursor:pointer; font-size:1.1rem; box-shadow:0 5px 20px rgba(233,69,96,0.5); transition:transform 0.2s, box-shadow 0.2s"
                onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 10px 25px rgba(233,69,96,0.6)'"
                onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 5px 20px rgba(233,69,96,0.5)'"
                data-i18n="btn_match">
                <i class="fas fa-infinity" style="margin-right:10px"></i> UYUMU ANALÄ°Z ET
            </button>
        </div>

        <div id="syn-res" style="margin-top:40px;"></div>
    </div>
</section>

<script>
    // --- SYNASTRY ---

    // Smart User Data Fetcher
    async function initSynastry() {
        const dInput = document.getElementById('syn-user-date');
        if (!dInput) return;

        // 1. Global Variable Check
        if (window.USER_BIRTH_DATE && window.USER_BIRTH_DATE.length > 5) {
            dInput.value = window.USER_BIRTH_DATE;
            return;
        }

        // 2. Fetch Attempts
        const endpoints = ['/api/get-user-info/', '/api/profile/', '/auth/users/me/', '/api/user/'];
        let found = false;

        for (let url of endpoints) {
            try {
                const res = await fetch(url);
                if (res.ok) {
                    const data = await res.json();
                    // Check various possible keys
                    const bdate = data.birth_date || data.date_of_birth || (data.profile ? data.profile.birth_date : null);

                    if (bdate) {
                        dInput.value = bdate;
                        window.USER_BIRTH_DATE = bdate; // Cache
                        found = true;
                        break;
                    }
                }
            } catch (e) { }
        }

        // 3. Last Resort: Unlock input for manual entry
        if (!found) {
            console.log("User birth date not found, unlocking input.");
            dInput.readOnly = false;
            dInput.style.cursor = "text";
            dInput.style.background = "rgba(0,0,0,0.3)";
            dInput.style.border = "1px solid rgba(255,255,255,0.3)";

            const msg = document.getElementById('syn-lock-msg');
            if (msg) {
                msg.innerHTML = '<i class="fas fa-exclamation-circle"></i> Otomatik veri alÄ±namadÄ±, lÃ¼tfen giriniz.';
                msg.style.color = "#ffd700";
                msg.style.opacity = "1";
            }
        }
    }

    // Trigger init
    initSynastry();
    setTimeout(initSynastry, 1000); // Retry after a second

    async function calcSynastry() {
        const btn = document.querySelector('#view-synastry button');
        const originalText = btn.innerHTML;

        let date1 = document.getElementById('syn-user-date').value;
        let date2 = document.getElementById('syn-partner-date').value;

        if (!date1) {
            alert("LÃ¼tfen kendi doÄŸum tarihinizi giriniz.");
            return;
        }
        if (!date2) {
            alert("LÃ¼tfen partnerinizin doÄŸum tarihini giriniz.");
            return;
        }

        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> HesaplanÄ±yor...';
        btn.disabled = true;

        const lang = document.getElementById('lang').value;

        try {
            const res = await fetch('/api/calculate-synastry/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date1, time1: "12:00", date2, time2: "12:00", lang })
            });
            const data = await res.json();

            if (data.error) {
                alert("Hata: " + data.error);
            } else {
                const resDiv = document.getElementById('syn-res');
                const terms = (typeof astroTerms !== 'undefined') ? astroTerms[lang] : {};

                // Groups Logic
                const groups = { 'Soul Connection': [], 'Attraction': [], 'Communication': [], 'Challenges': [] };
                let lovePoints = 0; let commPoints = 0;

                if (data.aspects) {
                    data.aspects.forEach(a => {
                        if (a.category === 'growth') groups['Challenges'].push(a);
                        else if (a.category === 'passion') { groups['Attraction'].push(a); lovePoints++; }
                        else { groups['Soul Connection'].push(a); lovePoints++; }
                        if (a.p1 === 'Mercury' || a.p2 === 'Mercury') commPoints++;
                    });
                }

                const loveStrength = Math.min(100, lovePoints * 20 + 20);
                const commStrength = Math.min(100, commPoints * 25 + 20);

                const aspectTerms = {
                    en: { Conjunction: "Conjunction", Opposition: "Opposition", Square: "Square", Trine: "Trine", Sextile: "Sextile" },
                    tr: { Conjunction: "KavuÅŸum", Opposition: "KarÅŸÄ±t", Square: "Kare", Trine: "ÃœÃ§gen", Sextile: "Sekstil" }
                };

                const renderList = (list, icon) => {
                    if (!list.length) return `<div style="opacity:0.6; font-size:0.9rem; font-style:italic; padding:10px">${lang === 'tr' ? 'Bu kategoride Ã¶nemli bir aÃ§Ä± bulunamadÄ±.' : 'No major aspects found.'}</div>`;
                    return list.map((a, idx) => {
                        const p1 = terms[a.p1] || a.p1;
                        const p2 = terms[a.p2] || a.p2;
                        const typeVal = aspectTerms[lang][a.type] || a.type;
                        const uid = `syn-item-${Math.random().toString(36).substr(2, 9)}`;
                        return `
                        <div style="background:rgba(255,255,255,0.03); border-radius:8px; margin-bottom:8px; overflow:hidden; transition:background 0.3s; border:1px solid rgba(255,255,255,0.05)">
                            <div onclick="const d=document.getElementById('${uid}'); const c=this.querySelector('.fa-chevron-down'); if(d.style.display==='none'){d.style.display='block'; c.style.transform='rotate(180deg)'; this.parentElement.style.background='rgba(255,255,255,0.08)'}else{d.style.display='none'; c.style.transform='rotate(0deg)'; this.parentElement.style.background='rgba(255,255,255,0.03)'}" 
                                 style="padding:12px 15px; cursor:pointer; display:flex; align-items:center; justify-content:space-between">
                                <div style="display:flex; align-items:center; gap:12px; font-size:0.95rem">
                                    <span style="color:var(--accent); font-size:1.2rem">${icon}</span>
                                    <span><b>${p1}</b> ${typeVal} <b>${p2}</b></span>
                                </div>
                                <i class="fas fa-chevron-down" style="font-size:0.8rem; opacity:0.5; transition:transform 0.3s"></i>
                            </div>
                            <div id="${uid}" style="display:none; padding:15px; border-top:1px solid rgba(255,255,255,0.1); font-size:0.95rem; line-height:1.6; color:rgba(255,255,255,0.9); background:rgba(0,0,0,0.2)">
                                ${a.interpretation || (lang === 'tr' ? 'DetaylÄ± yorum bulunamadÄ±.' : 'No detail available.')}
                            </div>
                        </div>`;
                    }).join('');
                };

                let html = `
                <div style="animation:fadeIn 0.8s">
                    <div class="glass-card" style="text-align:center; padding:40px; border-bottom: 4px solid var(--accent); background:linear-gradient(to bottom, rgba(233,69,96,0.1), rgba(0,0,0,0.3))">
                        <h4 style="letter-spacing:3px; opacity:0.8; margin-bottom:15px; text-transform:uppercase">${lang === 'tr' ? 'UYUM SKORU' : 'COMPATIBILITY SCORE'}</h4>
                        <div style="font-size:6rem; font-weight:800; color:var(--accent); line-height:1; margin-bottom:20px; text-shadow:0 0 30px rgba(233,69,96,0.4); font-family:'Cinzel'">${data.score}%</div>
                        <p style="font-size:1.4rem; font-style:italic; opacity:0.9; max-width:700px; margin:0 auto; font-family:'Cinzel'">"${data.summary}"</p>
                    </div>
                    <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px; margin-top:30px">
                         <div class="glass-card" style="padding:20px">
                            <h4 style="margin-bottom:15px; display:flex; align-items:center; gap:10px"><i class="fas fa-heart" style="color:#e91e63"></i> ${lang === 'tr' ? 'Romantik Ã‡ekim' : 'Romantic Attraction'}</h4>
                            <div style="background:rgba(255,255,255,0.1); border-radius:10px; height:12px; width:100%"><div style="width:${loveStrength}%; background:linear-gradient(90deg, #e91e63, #ff4081); height:100%; border-radius:10px; transition:width 1s; box-shadow:0 0 10px rgba(233,30,99,0.5)"></div></div>
                            <div style="text-align:right; font-size:0.9rem; margin-top:8px; opacity:0.8; font-weight:bold">${loveStrength > 70 ? (lang === 'tr' ? 'Ã‡ok GÃ¼Ã§lÃ¼ ğŸ”¥' : 'Very Strong') : (lang === 'tr' ? 'Orta Seviye' : 'Moderate')}</div>
                         </div>
                         <div class="glass-card" style="padding:20px">
                            <h4 style="margin-bottom:15px; display:flex; align-items:center; gap:10px"><i class="fas fa-comments" style="color:#03a9f4"></i> ${lang === 'tr' ? 'Ä°letiÅŸim & Zeka' : 'Communication'}</h4>
                            <div style="background:rgba(255,255,255,0.1); border-radius:10px; height:12px; width:100%"><div style="width:${commStrength}%; background:linear-gradient(90deg, #03a9f4, #00bcd4); height:100%; border-radius:10px; transition:width 1s; box-shadow:0 0 10px rgba(3,169,244,0.5)"></div></div>
                            <div style="text-align:right; font-size:0.9rem; margin-top:8px; opacity:0.8; font-weight:bold">${commStrength > 70 ? (lang === 'tr' ? 'AkÄ±ÅŸkan ğŸŒŠ' : 'Fluid') : (lang === 'tr' ? 'GeliÅŸtirilebilir' : 'Needs Work')}</div>
                         </div>
                    </div>
                    <!-- Details Logic -->
                    ${data.is_restricted ?
                        `<div style="margin-top:40px; text-align:center; padding:60px 20px; background:rgba(255,255,255,0.02); border:1px dashed rgba(255,215,0,0.3); border-radius:15px; position:relative; overflow:hidden">
                            <!-- Blurry Background Effect -->
                            <div style="filter:blur(8px); pointer-events:none; opacity:0.3; user-select:none; transform:scale(1.02)">
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; text-align:left">
                                     <div class="glass-card" style="height:150px"><h3>Ruhsal BaÄŸ Analizi</h3><p>GÃ¼neÅŸ ve Ay arasÄ±ndaki bu aÃ§Ä±...</p></div>
                                     <div class="glass-card" style="height:150px"><h3>Karmik Dersler</h3><p>SatÃ¼rn transiti iliÅŸkinizde...</p></div>
                                </div>
                            </div>
                            
                            <!-- Lock Overlay -->
                            <div style="position:absolute; top:0; left:0; width:100%; height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center; background:linear-gradient(to bottom, rgba(0,0,0,0.4), rgba(0,0,0,0.8)); z-index:10">
                                <div style="background:rgba(0,0,0,0.6); padding:30px; border-radius:20px; border:1px solid var(--gold); box-shadow:0 0 30px rgba(255,215,0,0.2); backdrop-filter:blur(10px)">
                                    <i class="fas fa-lock" style="font-size:2.5rem; color:var(--gold); margin-bottom:15px"></i>
                                    <h3 style="color:white; margin-bottom:10px; font-family:'Cinzel'">DetaylÄ± Analiz Kilitli</h3>
                                    <p style="color:#ccc; margin-bottom:20px; font-size:0.95rem">Ä°liÅŸkinizin tÃ¼m gizli yÃ¶nlerini, karmik baÄŸlarÄ±nÄ± ve<br>iletiÅŸim kodlarÄ±nÄ± keÅŸfetmek iÃ§in Premium Ã¼ye olun.</p>
                                    <button class="btn" onclick="showUpgradeModal('AÅŸk Uyumu detaylarÄ± iÃ§in Ã¼yeliÄŸinizi yÃ¼kseltin.')" 
                                            style="background:linear-gradient(45deg, #FFD700, #FDB931); color:black; font-weight:bold; border-radius:30px; padding:12px 30px; border:none; box-shadow:0 5px 15px rgba(255,215,0,0.3); cursor:pointer; transition:transform 0.2s">
                                        <i class="fas fa-crown"></i> DETAYLARI AÃ‡
                                    </button>
                                </div>
                            </div>
                         </div>`
                        :
                        `<div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:25px; margin-top:30px">
                            <div class="glass-card">
                                <h3 style="color:#9c27b0; margin-bottom:20px; font-family:'Cinzel'"><i class="fas fa-infinity"></i> ${lang === 'tr' ? 'Ruhsal BaÄŸ' : 'Soul Connection'}</h3>
                                ${renderList(groups['Soul Connection'], 'âœ¨')}
                            </div>
                            <div class="glass-card">
                                <h3 style="color:#e91e63; margin-bottom:20px; font-family:'Cinzel'"><i class="fas fa-fire"></i> ${lang === 'tr' ? 'Tutku & Ã‡ekim' : 'Passion & Attraction'}</h3>
                                ${renderList(groups['Attraction'], 'ğŸ”¥')}
                            </div>
                            <div class="glass-card">
                                <h3 style="color:#ff9800; margin-bottom:20px; font-family:'Cinzel'"><i class="fas fa-exclamation-circle"></i> ${lang === 'tr' ? 'GeliÅŸim AlanlarÄ±' : 'Challenges'}</h3>
                                ${renderList(groups['Challenges'], 'âš ï¸')}
                            </div>
                        </div>`
                    }
                </div>`;
                resDiv.innerHTML = html;
            }
        } catch (e) {
            alert("BaÄŸlantÄ± HatasÄ±: " + e);
        }
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
</script>