{% load static %}
<br>
<br>
<div id="view-blog" class="view" style="display:none">
    <!-- Header Section -->
    <div
        style="background:var(--gradient-start); padding:20px 40px; border-bottom:1px solid var(--border); margin-bottom:20px; text-align:center">
        <h2 style="color:var(--gold); font-size:2rem; margin-bottom:10px" data-i18n="blog_title">Kozmik Yazılar</h2>
        <p style="color:var(--text-muted); max-width:600px; margin:0 auto; font-size:0.95rem" data-i18n="blog_desc">
            Astroloji, gökyüzü hareketleri ve ruhsal gelişim üzerine derinlemesine analizler.
        </p>
    </div>

    <!-- Search Bar & Filter -->
    <div style="max-width:700px; margin:0 auto 30px auto; padding:0 20px;">
        <form method="GET" action="#view-blog" style="display:flex; gap:10px; flex-wrap:wrap">
            <!-- Search Text -->
            <input type="text" name="q" value="{{ search_query }}" placeholder="Kozmik arşivde ara..."
                style="flex:2; min-width:200px; padding:12px 20px; border-radius:30px; border:1px solid var(--border); background:rgba(255,255,255,0.05); color:white; outline:none; font-family:'Outfit'">

            <!-- Date Filter -->
            <input type="date" name="date" value="{{ date_filter }}"
                style="flex:1; min-width:130px; padding:12px 20px; border-radius:30px; border:1px solid var(--border); background:rgba(255,255,255,0.05); color:white; outline:none; font-family:'Outfit'; color-scheme: dark;">

            <button type="submit" class="btn" style="border-radius:30px; padding:0 25px;">
                <i class="fas fa-search"></i>
            </button>

            {% if search_query or date_filter %}
            <a href="?#view-blog" class="btn"
                style="background:var(--border); display:flex; align-items:center; justify-content:center; width:45px; border-radius:30px">
                <i class="fas fa-times"></i>
            </a>
            {% endif %}
        </form>
    </div>

    <!-- Blog Posts Container -->
    <div id="blog-posts-container"
        style="max-width:900px; margin:0 auto; padding:20px; display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:30px;">
        {% if blog_posts %}
        {% for post in blog_posts %}
        <!-- Card Item -->
        <div>
            <div onclick="openBlogPost('{{ post.slug }}')" class="blog-card"
                style="background:var(--card-bg); border-radius:15px; overflow:hidden; border:1px solid var(--border); cursor:pointer; transition:transform 0.3s, box-shadow 0.3s; height:100%; display:flex; flex-direction:column; position:relative;">
                <div style="height:200px; overflow:hidden; background:#222; position:relative;">
                    <img src="{% if post.banner_image %}{{ post.banner_image.url }}{% else %}{{ post.image_url }}{% endif %}"
                        alt="{{ post.title }}" loading="lazy" referrerpolicy="no-referrer"
                        onerror="this.onerror=null; this.src='https://images.unsplash.com/photo-1532968961962-8a0cb3a2d4f5?auto=format&fit=crop&w=800&q=60';"
                        style="width:100%; height:100%; object-fit:cover; transition:transform 0.5s">
                </div>
                <div style="padding:20px; flex:1; display:flex; flex-direction:column">
                    <div style="color:var(--accent); font-size:0.8rem; font-weight:bold; margin-bottom:10px">
                        {{ post.created_at|date:"d M Y" }}
                    </div>

                    <h3 style="color:var(--text); font-size:1.2rem; margin-bottom:10px; line-height:1.4">{{ post.title }}</h3>
                        

                    <div
                        style="margin-top:auto; padding-top:15px; border-top:1px solid rgba(255,255,255,0.05); display:flex; justify-content:space-between; align-items:center">
                        <span style="color:var(--text-muted); font-size:0.9rem">Devamını Oku</span>
                        <i class="fas fa-arrow-right" style="color:var(--gold)"></i>
                    </div>
                </div>
            </div>

            <!-- Hidden Content for Modal (Must be outside the card onclick wrapper to avoid bubble issues, but kept here for logical grouping) -->
            <div id="post-content-{{ post.slug }}" style="display:none">
                <img src="{% if post.banner_image %}{{ post.banner_image.url }}{% else %}{{ post.image_url }}{% endif %}"
                    style="width:100%; max-height:300px; object-fit:cover; border-radius:10px; margin-bottom:20px"
                    onerror="this.style.display='none'">
                {{ post.content|safe }}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div style="grid-column: 1/-1; text-align:center; padding:50px; color:var(--text-muted)">
            <i class="fas fa-feather-alt" style="font-size:3rem; margin-bottom:20px; opacity:0.5"></i>
            <p>Henüz yazı eklenmemiş veya aramanızla eşleşen sonuç bulunamadı.</p>
        </div>
        {% endif %}
    </div>

    <!-- Pagination Controls (Outside Grid) -->
    {% if blog_posts.paginator.num_pages > 1 %}
    <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin:30px 0 50px 0;">
        {% if blog_posts.has_previous %}
        <a href="?page={{ blog_posts.previous_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if date_filter %}&date={{ date_filter }}{% endif %}#view-blog"
            class="btn" style="background:rgba(255,255,255,0.1); padding:10px 20px;">
            <i class="fas fa-chevron-left"></i> Önceki
        </a>
        {% endif %}

        <span style="color:var(--text-muted); font-family:'Cinzel';">
            Sayfa {{ blog_posts.number }} / {{ blog_posts.paginator.num_pages }}
        </span>

        {% if blog_posts.has_next %}
        <a href="?page={{ blog_posts.next_page_number }}{% if search_query %}&q={{ search_query }}{% endif %}{% if date_filter %}&date={{ date_filter }}{% endif %}#view-blog"
            class="btn" style="background:var(--accent); padding:10px 20px;">
            Sonraki <i class="fas fa-chevron-right" style="margin-left:5px"></i>
        </a>
        {% endif %}
    </div>
    {% endif %}

</div>

<!-- Blog Reading Modal Template -->
<div id="blog-modal" class="modal-overlay" style="display:none; z-index:9999">
    <div class="modal-content"
        style="max-width:800px; width:95%; max-height:90vh; overflow-y:auto; background:var(--bg-dark); border:1px solid var(--border)">
        <div class="modal-header">
            <h3 id="blog-modal-title" style="font-family:'Cinzel'; color:var(--gold)"></h3>
            <span class="close-modal" onclick="closeBlogModal()">&times;</span>
        </div>
        <div id="blog-modal-body" style="line-height:1.8; color:var(--text); font-size:1.05rem">
            <!-- Content Injected Here -->
        </div>
    </div>
</div>

<style>
    .blog-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    .blog-card:hover img {
        transform: scale(1.1);
    }

    #blog-modal-body h3 {
        color: var(--accent);
        margin-top: 30px;
        margin-bottom: 15px;
        font-family: 'Cinzel', serif;
    }

    #blog-modal-body {
        color: var(--text) !important;
    }

    #blog-modal-body p,
    #blog-modal-body ul,
    #blog-modal-body li {
        color: var(--text) !important;
    }

    /* Light Theme Specific Override for Modal Background */
    [data-theme="light"] .modal-content {
        background: #ffffff !important;
        color: #333 !important;
    }

    [data-theme="light"] #blog-modal-body {
        color: #333 !important;
    }

    #blog-modal-body ul {
        margin-left: 20px;
        margin-bottom: 20px;
    }

    #blog-modal-body p {
        margin-bottom: 20px;
    }
</style>

<script>
    function openBlogPost(slug) {
        const contentDiv = document.getElementById('post-content-' + slug);
        const modalBody = document.getElementById('blog-modal-body');

        if (contentDiv && modalBody) {
            modalBody.innerHTML = contentDiv.innerHTML;
        }

        const modal = document.getElementById('blog-modal');
        modal.style.display = 'flex';
        modal.classList.add('animate-in');
    }

    function closeBlogModal() {
        document.getElementById('blog-modal').style.display = 'none';
    }

    document.getElementById('blog-modal').addEventListener('click', function (e) {
        if (e.target === this) closeBlogModal();
    });
</script>