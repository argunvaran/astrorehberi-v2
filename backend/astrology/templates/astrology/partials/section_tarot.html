
<br>
<br>
<!-- TAROT ROOM -->
<div id="view-tarot" class="view" style="display:none">
    <div style="max-width:800px; margin:0 auto; text-align:center">
        <h2 style="color:var(--gold); margin-bottom:10px; font-size:2.5rem; text-shadow:0 0 10px rgba(255,215,0,0.5)">
            Mistik Tarot</h2>
        <p style="opacity:0.7; margin-bottom:40px; font-size:1.1rem; color:var(--text)">Sorunuza odaklanƒ±n, zihninizi
            bo≈üaltƒ±n.</p>
        <div style="display:flex; justify-content:center; gap:10px; margin-bottom:30px">
            <button id="tab-tarot-shuffle" class="btn" style="padding:10px 20px; font-size:0.9rem"
                onclick="setTarotMode('shuffle')">Kart Se√ß</button>
            <button id="tab-tarot-manual" class="btn"
                style="padding:10px 20px; font-size:0.9rem; background:transparent; border:1px solid var(--border); color:var(--text)"
                onclick="setTarotMode('manual')">Kartlarƒ± Gir</button>
        </div>

        <div id="tarot-manual-panel" style="display:none; max-width:500px; margin:0 auto" class="animate-in">
            <div class="glass-card">
                <div id="manual-card-inputs"></div>
                <button class="btn" onclick="revealManualTarot()" style="margin-top:20px">Yorumla</button>
            </div>
        </div>

        <div id="tarot-table" class="tarot-table">
            <!-- Deck Pile -->
            <div id="tarot-deck-pile"
                style="position:relative; width:100px; height:170px; cursor:pointer; margin:0 auto"
                onclick="startTarot()">
                <div class="tarot-card-container" style="top:0; left:0; transform:translateZ(0px)">
                    <div class="card-face card-back"></div>
                </div>
                <div class="tarot-card-container" style="top:-2px; left:-2px; transform:translateZ(-1px)">
                    <div class="card-face card-back"></div>
                </div>
                <div class="tarot-card-container" style="top:-4px; left:-4px; transform:translateZ(-2px)">
                    <div class="card-face card-back"></div>
                </div>
                <div
                    style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:200px; text-align:center; color:white; font-weight:bold; text-shadow:0 2px 4px black; pointer-events:none">
                    KARI≈ûTIRMAK ƒ∞√áƒ∞N DOKUN</div>
            </div>
        </div>
    </div>

    <!-- Slots -->
    <div id="tarot-slots"
        style="display:flex; gap:20px; margin-bottom:30px; min-height:180px; justify-content:center; flex-wrap:wrap">
        <div id="slot-0" class="selected-slot"
            style="width:100px; height:170px; border:2px dashed rgba(255,255,255,0.2); border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.5; font-size:0.8rem">
            <span>GE√áMƒ∞≈û</span><i class="fas fa-history" style="margin-top:5px"></i>
        </div>
        <div id="slot-1" class="selected-slot"
            style="width:100px; height:170px; border:2px dashed rgba(255,255,255,0.2); border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.5; font-size:0.8rem">
            <span>≈ûƒ∞MDƒ∞</span><i class="fas fa-hourglass-half" style="margin-top:5px"></i>
        </div>
        <div id="slot-2" class="selected-slot"
            style="width:100px; height:170px; border:2px dashed rgba(255,255,255,0.2); border-radius:12px; display:flex; flex-direction:column; align-items:center; justify-content:center; opacity:0.5; font-size:0.8rem">
            <span>GELECEK</span><i class="fas fa-rocket" style="margin-top:5px"></i>
        </div>
    </div>

    <div style="text-align:center; margin-bottom:30px">
        <button id="btn-reveal-tarot" class="btn"
            style="display:none; background:var(--gold); color:black; font-weight:800; animation:pulse 1s infinite; font-size:1.2rem; padding:15px 40px"
            onclick="revealTarot()">KADERƒ∞Nƒ∞ G√ñR</button>
    </div>

    <div id="tarot-reading-area" class="reading-area"
        style="display:none; padding-bottom:50px; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px">
    </div>
    <div style="margin-top:20px; cursor:pointer; opacity:0.5; font-size:0.9rem; text-align:center"
        onclick="resetTarot()"><i class="fas fa-redo"></i> Masayƒ± Sƒ±fƒ±rla</div>
</div>

<script>
    /* TAROT LOGIC */
    let tarotState = 'deck'; // deck, spread, selected, revealed
    let selectedTarotCards = [];
    let fetchedTarotData = []; // Cards
    let fetchedTarotResponse = null; // Full Response

    const tarotDeckList = [
        { id: "fool", tr: "Deli (Joker)", en: "The Fool" },
        { id: "magician", tr: "B√ºy√ºc√º", en: "The Magician" },
        { id: "high_priestess", tr: "Azize", en: "The High Priestess" },
        { id: "empress", tr: "ƒ∞mparatori√ße", en: "The Empress" },
        { id: "emperor", tr: "ƒ∞mparator", en: "The Emperor" },
        { id: "hierophant", tr: "Aziz", en: "The Hierophant" },
        { id: "lovers", tr: "A≈üƒ±klar", en: "The Lovers" },
        { id: "chariot", tr: "Sava≈ü Arabasƒ±", en: "The Chariot" },
        { id: "strength", tr: "G√º√ß", en: "Strength" },
        { id: "hermit", tr: "Ermi≈ü", en: "The Hermit" },
        { id: "wheel_of_fortune", tr: "Kader √áarkƒ±", en: "Wheel of Fortune" },
        { id: "justice", tr: "Adalet", en: "Justice" },
        { id: "hanged_man", tr: "Asƒ±lan Adam", en: "The Hanged Man" },
        { id: "death", tr: "√ñl√ºm", en: "Death" },
        { id: "temperance", tr: "Denge", en: "Temperance" },
        { id: "devil", tr: "≈ûeytan", en: "The Devil" },
        { id: "tower", tr: "Yƒ±kƒ±lan Kule", en: "The Tower" },
        { id: "star", tr: "Yƒ±ldƒ±z", en: "The Star" },
        { id: "moon", tr: "Ay", en: "The Moon" },
        { id: "sun", tr: "G√ºne≈ü", en: "The Sun" },
        { id: "judgement", tr: "Mahkeme", en: "Judgement" },
        { id: "world", tr: "D√ºnya", en: "The World" },
        // CUPS
        { id: "ace_cups", tr: "Kupa Asƒ±", en: "Ace of Cups" },
        { id: "two_cups", tr: "Kupa ƒ∞kilisi", en: "Two of Cups" },
        { id: "three_cups", tr: "Kupa √ú√ßl√ºs√º", en: "Three of Cups" },
        { id: "four_cups", tr: "Kupa D√∂rtl√ºs√º", en: "Four of Cups" },
        { id: "five_cups", tr: "Kupa Be≈ülisi", en: "Five of Cups" },
        { id: "six_cups", tr: "Kupa Altƒ±lƒ±sƒ±", en: "Six of Cups" },
        { id: "seven_cups", tr: "Kupa Yedilisi", en: "Seven of Cups" },
        { id: "eight_cups", tr: "Kupa Sekizlisi", en: "Eight of Cups" },
        { id: "nine_cups", tr: "Kupa Dokuzlusu", en: "Nine of Cups" },
        { id: "ten_cups", tr: "Kupa Onlusu", en: "Ten of Cups" },
        { id: "page_cups", tr: "Kupa Prensi", en: "Page of Cups" },
        { id: "knight_cups", tr: "Kupa ≈û√∂valyesi", en: "Knight of Cups" },
        { id: "queen_cups", tr: "Kupa Krali√ßesi", en: "Queen of Cups" },
        { id: "king_cups", tr: "Kupa Kralƒ±", en: "King of Cups" },
        // WANDS
        { id: "ace_wands", tr: "Deƒünek Asƒ±", en: "Ace of Wands" },
        { id: "two_wands", tr: "Deƒünek ƒ∞kilisi", en: "Two of Wands" },
        { id: "three_wands", tr: "Deƒünek √ú√ßl√ºs√º", en: "Three of Wands" },
        { id: "four_wands", tr: "Deƒünek D√∂rtl√ºs√º", en: "Four of Wands" },
        { id: "five_wands", tr: "Deƒünek Be≈ülisi", en: "Five of Wands" },
        { id: "six_wands", tr: "Deƒünek Altƒ±lƒ±sƒ±", en: "Six of Wands" },
        { id: "seven_wands", tr: "Deƒünek Yedilisi", en: "Seven of Wands" },
        { id: "eight_wands", tr: "Deƒünek Sekizlisi", en: "Eight of Wands" },
        { id: "nine_wands", tr: "Deƒünek Dokuzlusu", en: "Nine of Wands" },
        { id: "ten_wands", tr: "Deƒünek Onlusu", en: "Ten of Wands" },
        { id: "page_wands", tr: "Deƒünek Prensi", en: "Page of Wands" },
        { id: "knight_wands", tr: "Deƒünek ≈û√∂valyesi", en: "Knight of Wands" },
        { id: "queen_wands", tr: "Deƒünek Krali√ßesi", en: "Queen of Wands" },
        { id: "king_wands", tr: "Deƒünek Kralƒ±", en: "King of Wands" },
        // SWORDS
        { id: "ace_swords", tr: "Kƒ±lƒ±√ß Asƒ±", en: "Ace of Swords" },
        { id: "two_swords", tr: "Kƒ±lƒ±√ß ƒ∞kilisi", en: "Two of Swords" },
        { id: "three_swords", tr: "Kƒ±lƒ±√ß √ú√ßl√ºs√º", en: "Three of Swords" },
        { id: "four_swords", tr: "Kƒ±lƒ±√ß D√∂rtl√ºs√º", en: "Four of Swords" },
        { id: "five_swords", tr: "Kƒ±lƒ±√ß Be≈ülisi", en: "Five of Swords" },
        { id: "six_swords", tr: "Kƒ±lƒ±√ß Altƒ±lƒ±sƒ±", en: "Six of Swords" },
        { id: "seven_swords", tr: "Kƒ±lƒ±√ß Yedilisi", en: "Seven of Swords" },
        { id: "eight_swords", tr: "Kƒ±lƒ±√ß Sekizlisi", en: "Eight of Swords" },
        { id: "nine_swords", tr: "Kƒ±lƒ±√ß Dokuzlusu", en: "Nine of Swords" },
        { id: "ten_swords", tr: "Kƒ±lƒ±√ß Onlusu", en: "Ten of Swords" },
        { id: "page_swords", tr: "Kƒ±lƒ±√ß Prensi", en: "Page of Swords" },
        { id: "knight_swords", tr: "Kƒ±lƒ±√ß ≈û√∂valyesi", en: "Knight of Swords" },
        { id: "queen_swords", tr: "Kƒ±lƒ±√ß Krali√ßesi", en: "Queen of Swords" },
        { id: "king_swords", tr: "Kƒ±lƒ±√ß Kralƒ±", en: "King of Swords" },
        // PENTACLES
        { id: "ace_pentacles", tr: "Tƒ±lsƒ±m Asƒ±", en: "Ace of Pentacles" },
        { id: "two_pentacles", tr: "Tƒ±lsƒ±m ƒ∞kilisi", en: "Two of Pentacles" },
        { id: "three_pentacles", tr: "Tƒ±lsƒ±m √ú√ßl√ºs√º", en: "Three of Pentacles" },
        { id: "four_pentacles", tr: "Tƒ±lsƒ±m D√∂rtl√ºs√º", en: "Four of Pentacles" },
        { id: "five_pentacles", tr: "Tƒ±lsƒ±m Be≈ülisi", en: "Five of Pentacles" },
        { id: "six_pentacles", tr: "Tƒ±lsƒ±m Altƒ±lƒ±sƒ±", en: "Six of Pentacles" },
        { id: "seven_pentacles", tr: "Tƒ±lsƒ±m Yedilisi", en: "Seven of Pentacles" },
        { id: "eight_pentacles", tr: "Tƒ±lsƒ±m Sekizlisi", en: "Eight of Pentacles" },
        { id: "nine_pentacles", tr: "Tƒ±lsƒ±m Dokuzlusu", en: "Nine of Pentacles" },
        { id: "ten_pentacles", tr: "Tƒ±lsƒ±m Onlusu", en: "Ten of Pentacles" },
        { id: "page_pentacles", tr: "Tƒ±lsƒ±m Prensi", en: "Page of Pentacles" },
        { id: "knight_pentacles", tr: "Tƒ±lsƒ±m ≈û√∂valyesi", en: "Knight of Pentacles" },
        { id: "queen_pentacles", tr: "Tƒ±lsƒ±m Krali√ßesi", en: "Queen of Pentacles" },
        { id: "king_pentacles", tr: "Tƒ±lsƒ±m Kralƒ±", en: "King of Pentacles" }
    ];

    function setTarotMode(mode) {
        const shuffleBtn = document.getElementById('tab-tarot-shuffle');
        const manualBtn = document.getElementById('tab-tarot-manual');
        const tableFn = document.getElementById('tarot-table');
        const tableSlots = document.getElementById('tarot-slots');
        const manualPanel = document.getElementById('tarot-manual-panel');
        const readingArea = document.getElementById('tarot-reading-area');
        const btnReveal = document.getElementById('btn-reveal-tarot');

        readingArea.style.display = 'none';
        btnReveal.style.display = 'none'; // Ensure main reveal btn is hidden

        if (mode === 'shuffle') {
            shuffleBtn.style.background = 'var(--accent)';
            manualBtn.style.background = 'transparent';

            tableFn.style.display = 'block';
            tableSlots.style.display = 'flex';
            manualPanel.style.display = 'none';

            resetTarot();
        } else {
            shuffleBtn.style.background = 'transparent';
            manualBtn.style.background = 'var(--accent)';

            tableFn.style.display = 'none';
            tableSlots.style.display = 'none';
            manualPanel.style.display = 'block';

            initManualTarot();
        }
    }

    function initManualTarot() {
        const container = document.getElementById('manual-card-inputs');
        const lang = document.getElementById('lang').value;
        const labels = lang === 'tr' ? ['Ge√ßmi≈ü', '≈ûimdi', 'Gelecek'] : ['Past', 'Present', 'Future'];
        const ph = lang === 'tr' ? 'Kart Se√ßiniz...' : 'Select Card...';

        let html = '';
        labels.forEach((label, i) => {
            html += `
            <div style="margin-bottom:15px">
                <label style="color:var(--gold); font-size:0.9rem">${label}</label>
                <div style="display:flex; gap:10px">
                    <select id="m-card-${i}" class="glass-input" style="flex:1; background:rgba(0,0,0,0.5)">
                        <option value="">${ph}</option>
                        ${tarotDeckList.map(c => `<option value="${c.id}">${lang === 'tr' ? c.tr : c.en}</option>`).join('')}
                    </select>
                    <div style="display:flex; align-items:center; gap:5px">
                        <input type="checkbox" id="m-rev-${i}">
                        <label for="m-rev-${i}" style="font-size:0.8rem">Ters</label>
                    </div>
                </div>
            </div>`;
        });
        container.innerHTML = html;
    }

    async function revealManualTarot() {
        const cards = [];
        for (let i = 0; i < 3; i++) {
            const sel = document.getElementById(`m-card-${i}`);
            const id = sel.value;
            const rev = document.getElementById(`m-rev-${i}`).checked;
            if (id) {
                cards.push({ id: id, reversed: rev, position_idx: i });
            }
        }

        if (cards.length < 1) {
            showToast(document.getElementById('lang').value === 'tr' ? "En az bir kart se√ßmelisiniz." : "You must select at least one card.", 'warning');
            return;
        }

        const btn = document.querySelector('#tarot-manual-panel button');
        const oldText = btn.innerText;
        btn.innerText = 'Analyzing...';
        btn.disabled = true;

        const lang = document.getElementById('lang').value;

        try {
            const res = await fetch('/api/draw-tarot/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cards: cards, lang: lang })
            });

            if (!res.ok) {
                const errText = await res.text();
                throw new Error(`Server ${res.status}: ${errText.substring(0, 100)}`);
            }

            const data = await res.json();

            if (data.error) {
                throw new Error(data.error);
            }

            fetchedTarotResponse = data;
            fetchedTarotData = data.cards;

            document.getElementById('tarot-manual-panel').style.display = 'none';

            const readingArea = document.getElementById('tarot-reading-area');
            readingArea.style.display = 'grid';
            readingArea.innerHTML = '';

            displayTarotCards();

        } catch (e) {
            console.error(e);
            alert("Hata: " + e.message);
        }

        btn.innerText = oldText;
        btn.disabled = false;
    }

    function displayTarotCards() {
        const readingArea = document.getElementById('tarot-reading-area');
        readingArea.innerHTML = '';

        if (!fetchedTarotData || fetchedTarotData.length === 0) return;

        // Simple 3-Upper Cards Display for Manual Mode (Static)
        let topCardsHtml = '<div style="display:flex; justify-content:center; gap:20px; margin-bottom:30px; flex-wrap:wrap">';
        fetchedTarotData.forEach(data => {
            topCardsHtml += `
                <div class="tarot-card-container flipped" style="position:relative; width:100px; height:170px; margin:0">
                    <div class="card-face card-front ${data.is_reversed ? 'reversed' : ''}" style="transform: rotateY(0deg)">
                        <div class="card-title" style="font-size:0.6rem; color:#333">${data.name}</div>
                        <div class="card-art" style="color:${data.color}; font-size:2.5rem; margin:5px 0">
                            ${data.element === 'Fire' ? 'üî•' : data.element === 'Water' ? 'üíß' : data.element === 'Air' ? 'üå™Ô∏è' : 'üåø'}
                        </div>
                        <div style="font-size:0.5rem; text-transform:uppercase; letter-spacing:1px; color:#555">${data.position}</div>
                    </div>
                </div>
            `;
        });
        topCardsHtml += '</div>';
        readingArea.innerHTML += topCardsHtml;

        // Detailed Interpretations
        fetchedTarotData.forEach((data, i) => {
            readingArea.innerHTML += `
                <div class="glass-card animate-in" style="text-align:left; animation-delay:${i * 0.2}s">
                     <h3 style="color:${data.color}; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:10px">
                        <i class="fas ${data.position === 'Past' || data.position === 'Ge√ßmi≈ü' ? 'fa-history' : data.position === 'Present' || data.position === '≈ûimdi' ? 'fa-hourglass-half' : 'fa-rocket'}"></i> 
                        ${data.position}: ${data.name} <span style="font-size:0.7em; opacity:0.7">${data.is_reversed ? '(Reversed)' : ''}</span>
                     </h3>
                     <p style="line-height:1.6; font-size:1rem">${data.meaning}</p>
                </div>
             `;
        });

        // Synthesis
        if (fetchedTarotResponse && fetchedTarotResponse.wish) {
            const summaryHtml = `
                <div class="glass-card animate-in" style="grid-column: 1 / -1; margin-top:30px; border:2px solid ${fetchedTarotResponse.wish.score >= 0 ? 'var(--gold)' : '#ff4444'}; background:linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,0,10,0.8)); animation-delay:0.8s">
                    <h2 style="color:${fetchedTarotResponse.wish.score >= 0 ? 'var(--gold)' : '#ff6666'}; text-align:center; margin-bottom:15px; font-size:1.8rem; text-shadow:0 0 10px rgba(0,0,0,0.5)">
                        <i class="fas fa-magic"></i> ${fetchedTarotResponse.wish.title}
                    </h2>
                    <p style="font-size:1.2rem; line-height:1.6; text-align:center; margin-bottom:20px; font-style:italic; color:#fff">"${fetchedTarotResponse.wish.text}"</p>
                    <hr style="border-color:rgba(255,255,255,0.1); margin-bottom:20px">
                    <h3 style="color:var(--text); margin-bottom:10px; text-transform:uppercase; letter-spacing:2px; font-size:1rem"><i class="fas fa-align-left"></i> ${document.getElementById('lang').value === 'tr' ? 'Kozmik √ñzet' : 'Cosmic Synthesis'}</h3>
                    <p style="opacity:0.9; line-height:1.8; text-align:justify; font-size:1.1rem">${fetchedTarotResponse.synthesis}</p>
                </div>
             `;
            readingArea.innerHTML += summaryHtml;

            // Scroll to view
            setTimeout(() => {
                const area = document.getElementById('view-tarot');
                area.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }
    }


    async function startTarot() {
        if (tarotState !== 'deck') return;

        const table = document.getElementById('tarot-table');
        table.innerHTML = ''; // Clear pile

        // 1. Fetch Data silently
        const lang = document.getElementById('lang').value;
        try {
            const res = await fetch(`/api/draw-tarot/?lang=${lang}`);
            const data = await res.json();

            // CHECK PREMIUM LIMIT
            if (data.upgrade_required) {
                if (typeof showUpgradeModal === 'function') {
                    showUpgradeModal(data.error);
                } else {
                    alert(data.error);
                }
                return; // Stop animation
            }

            fetchedTarotResponse = data; // Store full
            if (data.cards) fetchedTarotData = data.cards; // Keep for compatibility
        } catch (e) { console.error("Tarot Fetch Error", e); }

        // 2. Generate Spread (22 Cards Arc)
        const total = 22;
        const center = window.innerWidth < 768 ? 150 : 300;

        for (let i = 0; i < total; i++) {
            const card = document.createElement('div');
            card.className = 'tarot-card-container';
            card.innerHTML = `<div class="card-face card-back"></div><div class="card-face card-front"></div>`;

            // Initial: Center
            card.style.left = '50%';
            card.style.top = '50%';
            card.style.transform = 'translate(-50%, -50%)';
            card.style.transitionDelay = `${i * 0.05}s`;

            card.onclick = () => selectTarotCard(card, i);

            table.appendChild(card);

            // Spread Animation
            setTimeout(() => {
                const angle = -60 + (i * (120 / total)); // -60 to +60 deg
                const radius = 450; // Wider
                const x = Math.sin(angle * Math.PI / 180) * radius;
                const y = Math.cos(angle * Math.PI / 180) * radius * 0.2; // Much flatter (0.2) to avoid overlap

                // Shift UP by 60px to clear slots
                card.style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px - 60px)) rotate(${angle}deg)`;
            }, 100);
        }
        tarotState = 'spread';
        document.getElementById('tarot-slots').style.opacity = '1';
    }

    function selectTarotCard(el, index) {
        if (tarotState !== 'spread' || selectedTarotCards.length >= 3) return;
        if (el.classList.contains('picked')) return;

        const slotIndex = selectedTarotCards.length;
        selectedTarotCards.push(index);
        el.classList.add('picked');

        // Move to Slot (Physical DOM Move)
        const slot = document.getElementById(`slot-${slotIndex}`);

        // Clear slot placeholder (Past, Present icons)
        slot.innerHTML = '';
        slot.appendChild(el);

        // Reset Card Styles to fit container
        el.style.position = 'relative';
        el.style.top = '0';
        el.style.left = '0';
        el.style.transform = 'none';
        el.style.width = '100%';
        el.style.height = '100%';
        el.style.margin = '0';
        el.style.pointerEvents = 'none'; // Lock it
        el.style.zIndex = '10';

        // Remove Slot Styling
        slot.style.opacity = '1';
        slot.style.border = 'none';

        if (selectedTarotCards.length === 3) {
            document.getElementById('btn-reveal-tarot').style.display = 'inline-block';
        }
    }

    async function revealTarot() {
        const readingArea = document.getElementById('tarot-reading-area');
        readingArea.innerHTML = '';
        readingArea.style.display = 'grid';
        document.getElementById('btn-reveal-tarot').style.display = 'none';

        // Emergency Data Check
        if (!fetchedTarotData || fetchedTarotData.length < 3) {
            console.warn("Tarot data missing, attempting refetch...");
            const lang = document.getElementById('lang').value;
            try {
                const res = await fetch(`/api/draw-tarot/?lang=${lang}`);
                const data = await res.json();
                fetchedTarotResponse = data;
                if (data.cards) fetchedTarotData = data.cards;
            } catch (e) {
                alert("The stars are clouded. Please try again.");
                return;
            }
        }

        const pickedEls = document.querySelectorAll('.tarot-card-container.picked');

        pickedEls.forEach((el, i) => {
            const data = fetchedTarotData[i];
            if (!data) return;

            // 1. Flip Animation IN PLACE
            setTimeout(() => {
                el.classList.add('flipped');
                // Update Front Content
                const front = el.querySelector('.card-front');
                if (data.is_reversed) front.classList.add('reversed');

                front.innerHTML = `
                    <div class="card-title" style="font-size:0.6rem; color:#333">${data.name}</div>
                    <div class="card-art" style="color:${data.color}; font-size:2.5rem; margin:5px 0">${data.element === 'Fire' ? 'üî•' : data.element === 'Water' ? 'üíß' : data.element === 'Air' ? 'üå™Ô∏è' : 'üåø'}</div>
                    <div style="font-size:0.5rem; text-transform:uppercase; letter-spacing:1px; color:#555">${data.position}</div>
                 `;
            }, i * 600);

            // 2. Add description below
            setTimeout(() => {
                readingArea.innerHTML += `
                    <div class="glass-card animate-in" style="text-align:left">
                         <h3 style="color:${data.color}; border-bottom:1px solid rgba(255,255,255,0.1); padding-bottom:10px; margin-bottom:10px">
                            <i class="fas ${data.position === 'Past' ? 'fa-history' : data.position === 'Present' ? 'fa-hourglass-half' : 'fa-rocket'}"></i> 
                            ${data.position}: ${data.name} <span style="font-size:0.7em; opacity:0.7">${data.is_reversed ? '(Reversed)' : ''}</span>
                         </h3>
                         <p style="line-height:1.6; font-size:1rem">${data.meaning}</p>
                    </div>
                 `;
            }, 2000 + (i * 600));
        });

        // 3. Add Synthesis & Outcome
        setTimeout(() => {
            if (fetchedTarotResponse && fetchedTarotResponse.wish) {
                const summaryHtml = `
                    <div class="glass-card animate-in" style="grid-column: 1 / -1; margin-top:30px; border:2px solid ${fetchedTarotResponse.wish.score >= 0 ? 'var(--gold)' : '#ff4444'}; background:linear-gradient(135deg, rgba(0,0,0,0.8), rgba(20,0,10,0.8))">
                        <h2 style="color:${fetchedTarotResponse.wish.score >= 0 ? 'var(--gold)' : '#ff6666'}; text-align:center; margin-bottom:15px; font-size:1.8rem; text-shadow:0 0 10px rgba(0,0,0,0.5)">
                            <i class="fas fa-magic"></i> ${fetchedTarotResponse.wish.title}
                        </h2>
                        <p style="font-size:1.2rem; line-height:1.6; text-align:center; margin-bottom:20px; font-style:italic; color:#fff">"${fetchedTarotResponse.wish.text}"</p>
                        <hr style="border-color:rgba(255,255,255,0.1); margin-bottom:20px">
                        <h3 style="color:var(--text); margin-bottom:10px; text-transform:uppercase; letter-spacing:2px; font-size:1rem"><i class="fas fa-align-left"></i> ${document.getElementById('lang').value === 'tr' ? 'Kozmik √ñzet' : 'Cosmic Synthesis'}</h3>
                        <p style="opacity:0.9; line-height:1.8; text-align:justify; font-size:1.1rem">${fetchedTarotResponse.synthesis}</p>
                    </div>
                 `;
                readingArea.innerHTML += summaryHtml;
                setTimeout(() => {
                    const area = document.getElementById('view-tarot');
                }, 100);
            }
        }, 4000);
    }

    function resetTarot() {
        tarotState = 'deck';
        selectedTarotCards = [];
        document.getElementById('tarot-table').innerHTML = `
             <div id="tarot-deck-pile" style="position:relative; width:100px; height:170px; cursor:pointer" onclick="startTarot()">
                <div class="tarot-card-container" style="top:0; left:0; transform:translateZ(0px)"> <div class="card-face card-back"></div> </div>
                <div class="tarot-card-container" style="top:-2px; left:-2px; transform:translateZ(-1px)"> <div class="card-face card-back"></div> </div>
                <div class="tarot-card-container" style="top:-4px; left:-4px; transform:translateZ(-2px)"> <div class="card-face card-back"></div> </div>
                <div style="position:absolute; top:50%; left:50%; transform:translate(-50%, -50%); width:200px; text-align:center; color:white; font-weight:bold; text-shadow:0 2px 4px black; pointer-events:none">KARI≈ûTIRMAK ƒ∞√áƒ∞N DOKUN</div>
             </div>
         `;
        document.getElementById('tarot-reading-area').style.display = 'none';
        document.getElementById('btn-reveal-tarot').style.display = 'none';
    }
</script>