<section id="view-editor" class="view animate-in" style="display:none">
    <div style="max-width:900px; margin:0 auto">
        <h2
            style="color:var(--gold); font-family:'Cinzel'; margin-bottom:10px; display:flex; align-items:center; gap:10px">
            <i class="fas fa-edit" style="color:var(--accent)"></i> Kozmik İçerik Editörü
        </h2>
        <p style="opacity:0.7; margin-bottom:20px">Haftalık genel burç yorumunu veya blog yazısını buradan
            yayınlayabilirsiniz.</p>

        <div class="glass-card" style="padding:25px; border:1px solid var(--accent); position:relative">
            <div
                style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; color:var(--accent); margin-bottom:5px">
                YAZI BAŞLIĞI</div>
            <input type="text" id="post-title" placeholder="Örn: 24-30 Ocak Haftalık Burç Yorumları"
                style="width:100%; padding:15px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.3); color:white; font-family:'Outfit'; font-size:1.2rem; margin-bottom:15px; outline:none; transition:0.3s">

            <div
                style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; color:var(--accent); margin-bottom:5px">
                KAPAK GÖRSELİ (Opsiyonel)</div>
            <input type="file" id="post-image" accept="image/*"
                style="width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.3); color:white; font-family:'Outfit'; font-size:1rem; margin-bottom:15px; outline:none;">

            <div
                style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; color:var(--accent); margin-bottom:5px">
                YAYIN TARİHİ</div>
            <input type="datetime-local" id="post-date"
                style="width:100%; padding:15px; border-radius:8px; border:1px solid rgba(255,255,255,0.2); background:rgba(0,0,0,0.3); color:white; font-family:'Outfit'; font-size:1.1rem; margin-bottom:25px; outline:none;">

            <div
                style="font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; color:var(--accent); margin-bottom:5px">
                İÇERİK</div>

            <!-- SIMPLE TEXTAREA (Robust & Fail-safe) -->
            <textarea id="simple-editor" placeholder="Yıldızların mesajını buraya yazın..."
                style="width:100%; height:450px; padding:20px; border-radius:8px; border:none; resize:vertical; font-family:'Outfit', sans-serif; font-size:1.1rem; line-height:1.6; color:#000; background:#fff; outline:none; box-shadow:inset 0 0 10px rgba(0,0,0,0.1)"></textarea>

            <div style="font-size:0.8rem; opacity:0.6; margin-top:5px; text-align:right">Satır sonları otomatik olarak
                paragrafa dönüşür.</div>

            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:25px">
                <div id="editor-status" style="font-weight:bold; font-size:1rem"></div>
                <button onclick="saveEditorContent()" class="btn"
                    style="padding:15px 40px; font-size:1.1rem; border-radius:50px; background:var(--accent); color:white; border:none; cursor:pointer; font-weight:bold; letter-spacing:1px; box-shadow:0 5px 15px rgba(233,69,96,0.4); transition:transform 0.2s">
                    <i class="fas fa-paper-plane" style="margin-right:10px"></i> YAYINLA
                </button>
            </div>
        </div>
    </div>
</section>

<script>
    // No initialization needed for textarea
    function initEditor() {
        console.log("Simple Editor Ready");
        // Focus for UX
        const el = document.getElementById('simple-editor');
        if (el) el.focus();

        // Set Default Date to Now
        const dateEl = document.getElementById('post-date');
        if (dateEl) {
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            dateEl.value = now.toISOString().slice(0, 16);
        }
    }

    async function saveEditorContent() {
        const rawContent = document.getElementById('simple-editor').value;
        const title = document.getElementById('post-title').value;
        const dateVal = document.getElementById('post-date').value;
        const status = document.getElementById('editor-status');

        if (!title) { alert("Lütfen bir başlık giriniz."); return; }
        if (!rawContent) { alert("Lütfen içerik giriniz."); return; }

        status.innerText = "Yayınlanıyor...";
        status.style.color = "yellow";

        // Convert newlines to simple HTML breaks for display
        const content = rawContent.replace(/\n/g, '<br>');

        try {
            // CSRF Token Logic
            let token = '';
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, 10) === ('csrftoken=')) {
                        token = decodeURIComponent(cookie.substring(10));
                        break;
                    }
                }
            }

            const formData = new FormData();
            formData.append('title', title);
            formData.append('content', content);
            formData.append('published', 'true');
            formData.append('date', dateVal);

            const fileInput = document.getElementById('post-image');
            if (fileInput && fileInput.files[0]) {
                formData.append('image', fileInput.files[0]);
            }

            const res = await fetch('/cms/save/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': token
                },
                body: formData
            });
            const data = await res.json();
            if (data.success) {
                status.innerText = "✅ Başarıyla Yayınlandı!";
                status.style.color = "#4eff4e";
                // Reset
                setTimeout(() => {
                    document.getElementById('post-title').value = "";
                    document.getElementById('simple-editor').value = "";
                    status.innerText = "";
                }, 2000);
            } else {
                status.innerText = "Hata: " + (data.error || "Bilinmeyen hata");
                status.style.color = "#ff4444";
            }
        } catch (e) {
            console.error(e);
            status.innerText = "Sunucu bağlantı hatası.";
            status.style.color = "#ff4444";
        }
    }
</script>