{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="{% static 'astrology/favicon.png' %}?v=2">
    <link rel="shortcut icon" type="image/png" href="{% static 'astrology/favicon.png' %}?v=2">
    <title>Kozmik Duvar | Deep Cosmos</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Outfit:wght@300;400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* DARK THEME (DEFAULT) */
            --primary: #0F0C29;
            --gradient-start: #0F0C29;
            --gradient-mid: #302B63;
            --gradient-end: #24243E;
            --sidebar-bg: rgba(15, 12, 41, 0.95);
            --accent: #E94560;
            --gold: #FFD700;
            --text: #EEEEEE;
            --text-muted: rgba(255, 255, 255, 0.6);
            --border: rgba(255, 255, 255, 0.1);
            --card-bg: rgba(255, 255, 255, 0.05);
            --glass-card-bg: rgba(255, 255, 255, 0.05);
        }

        [data-theme="light"] {
            /* LIGHT THEME */
            --primary: #ffffff;
            --gradient-start: #fdfbfb;
            --gradient-mid: #ebedee;
            --gradient-end: #dce2e6;
            --sidebar-bg: rgba(255, 255, 255, 0.9);
            --accent: #D63447;
            --gold: #B8860B;
            /* Darker gold for light bg */
            --text: #1a1a1a;
            --text-muted: rgba(0, 0, 0, 0.6);
            --border: rgba(0, 0, 0, 0.1);
            --card-bg: rgba(255, 255, 255, 0.6);
            --glass-card-bg: rgba(255, 255, 255, 0.6);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-mid), var(--gradient-end));
            color: var(--text);
            margin: 0;
            height: 100vh;
            overflow: hidden;
            transition: background 0.5s ease, color 0.5s ease;
            /* App-like feel */
        }

        .page-wrapper {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        /* Main Layout */
        .main-content {
            flex: 1;
            margin-left: 280px;
            display: flex;
            flex-direction: column;
            /* Stack top bar and content */
            height: 100vh;
        }

        /* Inner Sidebar (Social Nav) */
        .social-nav {
            height: 80px;
            /* Fixed height for top bar */
            width: 100%;
            background: rgba(0, 0, 0, 0.2);
            border-bottom: 1px solid var(--border);
            display: flex;
            flex-direction: row;
            /* Horizontal */
            align-items: center;
            justify-content: center;
            /* Center icons */
            padding-top: 0;
            gap: 40px;
            /* Spacing between icons */
        }

        .nav-icon {
            width: 50px;
            height: 50px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--text-muted);
            cursor: pointer;
            transition: 0.3s;
            position: relative;
            margin-top: 5px;
            /* Minor adjustment */
        }

        .nav-icon:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .nav-icon.active {
            background: var(--accent);
            color: white;
            box-shadow: 0 0 15px rgba(233, 69, 96, 0.4);
        }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--gold);
            color: black;
            font-size: 0.7rem;
            font-weight: bold;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Dynamic Content Area */
        .content-area {
            flex: 1;
            padding: 0;
            overflow-y: auto;
            position: relative;
            background: rgba(0, 0, 0, 0.1);
        }

        .view-section {
            display: none;
            padding: 30px;
            max-width: 800px;
            margin: 0 auto;
            min-height: 100%;
        }

        .view-section.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- STYLES REUSED FROM PREVIOUS FILES --- */

        /* Wall Styles */
        .wall-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .avatar {
            width: 45px;
            height: 45px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            cursor: pointer;
        }

        .new-post-box {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 15px;
            border: 1px solid var(--gold);
            margin-bottom: 30px;
        }

        .feed-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .tab-item {
            cursor: pointer;
            padding: 5px 10px;
            color: var(--text-muted);
            font-weight: bold;
            transition: 0.3s;
        }

        .tab-item.active {
            color: var(--gold);
            border-bottom: 2px solid var(--gold);
        }

        /* Search Styles */
        .search-box {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid var(--gold);
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            margin-bottom: 30px;
        }

        .user-card {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 15px;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 10px;
            cursor: pointer;
            transition: 0.2s
        }

        .user-card:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Inbox/Notif Styles */
        .msg-card {
            background: var(--card-bg);
            border-left: 4px solid var(--accent);
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: default
        }

        .msg-card.read {
            opacity: 0.6;
            border-left-color: var(--border);
        }

        /* MESSAGES (Full Height Special Layout) */
        #view-messages {
            padding: 0;
            max-width: none;
            height: 100%;
            display: none;
        }

        #view-messages.active {
            display: flex;
        }

        .conv-list-panel {
            width: 300px;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
        }

        .chat-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(0, 0, 0, 0.1);
        }

        .conv-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-small {
            background: transparent;
            border: 1px solid var(--gold);
            color: var(--gold);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-small.active {
            background: var(--gold);
            color: black;
        }

        .btn-small:hover {
            transform: scale(1.05);
        }

        .conv-item:hover,
        .conv-item.active {
            background: rgba(233, 69, 96, 0.1);
            border-left: 3px solid var(--accent);
        }

        .chat-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .messages-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
            background: rgba(0, 0, 0, 0.2);
        }

        .message-bubble {
            max-width: 70%;
            padding: 10px 15px;
            border-radius: 15px;
            line-height: 1.4;
            font-size: 0.95rem;
        }

        .msg-sent {
            align-self: flex-end;
            background: var(--accent);
            color: white;
            border-bottom-right-radius: 2px;
        }

        .msg-received {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
            border-bottom-left-radius: 2px;
        }


        /* Mobile Toggle Default Hidden */
        .mobile-toggle {
            display: none !important;
        }

        @media (max-width: 768px) {

            /* Spacing for mobile nav */
            .content-area {
                padding-bottom: 70px;
            }

            .main-content {
                margin-left: 0;
                flex-direction: column-reverse;
            }

            .main-content {
                flex-direction: row;
            }

            /* Sidebar Responsive Behavior */
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            /* Bottom Nav */
            .social-nav {
                /* ... keep existing ... */
                position: fixed;
                bottom: 0;
                left: 0;
                width: 100%;
                height: 60px;
                flex-direction: row;
                justify-content: space-around;
                background: #0f0c29;
                border-top: 1px solid var(--border);
                border-right: none;
                z-index: 999;
                padding: 0;
            }

            /* Mobile Toggle Visible */
            .mobile-toggle {
                display: block !important;
                position: fixed;
                top: 15px;
                left: 15px;
                z-index: 1001;
                background: var(--accent);
                padding: 10px;
                border-radius: 50%;
                color: white;
            }

            #view-messages {
                flex-direction: column;
            }

            .conv-list-panel {
                width: 100%;
                height: 40%;
                display: block;
            }

            .chat-panel {
                height: 60%;
                display: block;
            }

            /* Responsive logic for chat: Show list or chat, not both on small screens? Keeping simple for now */
        }
    </style>
</head>

<body>
    <!-- Force hide on desktop via inline style, show via CSS media query -->
    <div class="mobile-toggle" style="display:none;" onclick="toggleSidebar()"><i class="fas fa-bars"></i></div>
    {% include 'astrology/partials/sidebar.html' %}

    <div class="page-wrapper">
        <div class="main-content">
            <!-- SOCIAL NAVIGATION (Horizontal Top Bar) -->
            <div class="social-nav"
                style="position:relative; display:flex; justify-content:center; align-items:center; background:rgba(15, 12, 41, 0.8);">
                <!-- NAV ICONS CENTERED -->
                <div style="display:flex; gap:30px">
                    <div class="nav-icon active" onclick="switchView('feed')" title="Akış">
                        <i class="fas fa-stream"></i>
                    </div>
                    <div class="nav-icon" onclick="switchView('explore')" title="Keşfet / Ara">
                        <i class="fas fa-search"></i>
                    </div>
                    <div class="nav-icon" onclick="switchView('messages')" title="Mesajlar">
                        <i class="fas fa-envelope"></i>
                    </div>
                    <div class="nav-icon" onclick="switchView('notifications')" title="Bildirimler">
                        <i class="fas fa-bell"></i>
                    </div>
                </div>

                <!-- AUTH WIDGET (Absolute Right) -->
                <div id="auth-widget"
                    style="position:absolute; right:20px; display:flex; gap:10px; align-items:center; height:100%">
                    <!-- NOTIFICATIONS BELL (Global) -->
                    <button onclick="switchView('notifications')" class="btn"
                        style="padding:0; width:40px; height:40px; border-radius:50%; background:var(--glass-card-bg); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; color:var(--gold); margin-right:5px; position:relative; cursor:pointer">
                        <i class="fas fa-bell" style="font-size:1.1rem"></i>
                        <span id="global-unread-count"
                            style="display:none; position:absolute; top:-5px; right:-5px; background:var(--accent); color:white; font-size:0.7rem; font-weight:bold; width:18px; height:18px; border-radius:50%; align-items:center; justify-content:center; box-shadow:0 0 5px var(--accent)">0</span>
                    </button>

                    <!-- THEME TOGGLE -->
                    <button onclick="toggleTheme()" class="btn"
                        style="padding:0; width:40px; height:40px; border-radius:50%; background:var(--glass-card-bg); border:1px solid var(--border); display:flex; align-items:center; justify-content:center; color:var(--gold); margin-right:10px; cursor:pointer">
                        <i id="theme-icon" class="fas fa-moon" style="font-size:1.2rem"></i>
                    </button>

                    <div id="user-display"
                        style="font-weight:bold; color:var(--gold); display:flex; align-items:center; cursor:pointer; margin-right:10px"
                        onclick="window.location.href='/interactive/user/{{ user.username }}/'">
                        <i class="fas fa-user-circle" style="margin-right:5px; font-size:1.2rem"></i> {{ user.username }}
                        
                    </div>

                    <button onclick="localStorage.clear(); window.location.href='/api/logout/';" class="btn"
                        style="padding:8px 20px; font-size:0.9rem; background:var(--accent); color:white; border:none; border-radius:20px; cursor:pointer; font-weight:bold">
                        <i class="fas fa-sign-out-alt" style="margin-right:5px"></i> Çıkış
                    </button>
                </div>
            </div>

            <!-- DYNAMIC CONTENT -->
            <div class="content-area">

                <!-- 1. FEED OBSERVER -->
                <div id="view-feed" class="view-section active">
                    <h1 style="font-family:'Cinzel'; color:var(--gold)">Kozmik Duvar</h1>

                    <!-- New Post -->
                    <div class="new-post-box">
                        <textarea id="post-content" rows="2" placeholder="Yıldızlar hakkında ne düşünüyorsun?"
                            style="width:100%; background:transparent; border:none; color:var(--text); font-family:'Outfit'; outline:none; resize:none; font-size:1rem"></textarea>
                        <div
                            style="text-align:right; margin-top:10px; border-top:1px solid var(--border); padding-top:10px">
                            <button onclick="sendPost()"
                                style="background:var(--accent); color:white; border:none; padding:8px 20px; border-radius:20px; cursor:pointer; font-weight:bold">Paylaş</button>
                        </div>
                    </div>

                    <!-- Search in Feed -->
                    <div style="margin-bottom:15px; position:relative">
                        <input type="text" id="feed-search" placeholder="Akışta ara..." onkeyup="searchFeed()"
                            style="width:100%; background:rgba(255,255,255,0.05); border:1px solid var(--border); padding:10px 15px; border-radius:30px; color:var(--text); outline:none; box-sizing: border-box;">
                        <i class="fas fa-search"
                            style="position:absolute; right:15px; top:12px; color:var(--text-muted)"></i>
                    </div>

                    <div class="feed-tabs">
                        <div class="tab-item active" onclick="switchFeedTab('all', this)">Genel Akış</div>
                        <div class="tab-item" onclick="switchFeedTab('following', this)">Takip Ettiklerim</div>
                        <div class="tab-item" onclick="switchFeedTab('self', this)">Kendi Yazılarım</div>
                    </div>

                    <div id="wall-feed-container">
                        <div style="text-align:center; padding:20px"><i class="fas fa-circle-notch fa-spin"></i>
                            Yükleniyor...</div>
                    </div>

                    <div id="feed-load-more" style="text-align:center; padding:20px; display:none">
                        <button onclick="loadMorePosts()"
                            style="background:transparent; border:1px solid var(--gold); color:var(--gold); padding:8px 20px; border-radius:20px; cursor:pointer">
                            Daha Fazla Göster
                        </button>
                    </div>
                </div>

                <!-- 2. EXPLORE -->
                <div id="view-explore" class="view-section">
                    <h1 style="font-family:'Cinzel'; color:var(--gold)">Kozmik İnsanlar</h1>
                    <div class="search-box">
                        <i class="fas fa-search" style="color:var(--gold); margin-right:15px"></i>
                        <input type="text" id="search-input" placeholder="Kullanıcı adı ara..." onkeyup="searchUsers()"
                            style="background:transparent; border:none; color:var(--text); width:100%; outline:none;">
                    </div>
                    <div id="explore-results">
                        <div style="text-align:center; opacity:0.5; margin-top:50px">Kullanıcı aramak için yazmaya
                            başla...</div>
                    </div>
                </div>

                <!-- 3. MESSAGES -->
                <div id="view-messages" class="view-section">
                    <!-- Conv List -->
                    <div class="conv-list-panel">
                        <div
                            style="padding:15px; border-bottom:1px solid var(--border); font-family:'Cinzel'; color:var(--gold)">
                            Sohbetler</div>
                        <div id="conv-list"></div>
                    </div>
                    <!-- Chat Area -->
                    <div class="chat-panel" id="chat-ui-container" style="display:none">
                        <div class="chat-header">
                            <span id="chat-partner-name"
                                style="font-weight:bold; font-size:1.1rem; color:var(--gold)">User</span>
                            <button onclick="visitProfile()"
                                style="background:none; border:1px solid var(--border); color:var(--text-muted); padding:5px 10px; border-radius:15px; cursor:pointer">Profil</button>
                        </div>
                        <div class="messages-container" id="msg-box"></div>
                        <div class="chat-input-area">
                            <input type="text" id="msg-input" placeholder="Mesaj yaz..."
                                style="flex:1; background:var(--input-bg, rgba(255,255,255,0.05)); border:1px solid var(--border); color:var(--text); padding:10px; border-radius:20px; outline:none;">
                            <button onclick="sendMessage()"
                                style="background:var(--gold); border:none; width:40px; height:40px; border-radius:50%; cursor:pointer"><i
                                    class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                    <!-- Empty State -->
                    <div id="chat-empty-state"
                        style="flex:1; display:flex; align-items:center; justify-content:center; opacity:0.5; flex-direction:column">
                        <i class="fas fa-comments" style="font-size:3rem; margin-bottom:15px"></i>
                        <p>Bir sohbet seç.</p>
                    </div>
                </div>

                <!-- 4. NOTIFICATIONS -->
                <div id="view-notifications" class="view-section">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px">
                        <h1 style="font-family:'Cinzel'; color:var(--gold); margin:0">Bildirimler</h1>
                        <button onclick="markAllRead()"
                            style="background:transparent; border:1px solid var(--border); color:white; padding:5px 15px; cursor:pointer; border-radius:15px">Tümünü
                            Okundu Say</button>
                    </div>
                    <div id="notif-list">
                        <div style="text-align:center; padding:20px"><i class="fas fa-circle-notch fa-spin"></i>
                            Yükleniyor...</div>
                    </div>
                    <div id="notif-load-more" style="text-align:center; padding:20px; display:none">
                        <button onclick="loadMoreNotifs()"
                            style="background:transparent; border:1px solid var(--gold); color:var(--gold); padding:8px 20px; border-radius:20px; cursor:pointer">
                            Eski Bildirimler
                        </button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        // GLOBAL STATE
        let currentView = 'feed';
        let feedFilter = 'all';
        let activeChatUser = null;
        const currentUser = "{{ user.username }}";

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            // Check Theme
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);

            // Check URL params
            const params = new URLSearchParams(window.location.search);
            const view = params.get('view');
            const user = params.get('user');

            if (view && ['feed', 'explore', 'messages', 'notifications'].includes(view)) {
                switchView(view);
            }
            if (view === 'messages' && user) {
                openChat(user);
            }

            // Initial loads
            loadFeed();
            loadConversations();
            loadNotifications();

            // Fix Sidebar Active State
            setTimeout(() => {
                const items = document.querySelectorAll('.nav-item');
                items.forEach(i => {
                    i.classList.remove('active');
                    // Check if item text contains 'Kozmik Duvar'
                    if (i.innerText.includes('Kozmik Duvar')) {
                        i.classList.add('active');
                    }
                });
            }, 100);
        });

        // THEME LOGIC
        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'dark';
            const next = current === 'dark' ? 'light' : 'dark';
            applyTheme(next);
            localStorage.setItem('theme', next);
        }

        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            const icon = document.getElementById('theme-icon');
            if (!icon) return;
            if (theme === 'light') {
                icon.className = 'fas fa-sun';
                icon.style.color = 'var(--accent)';
            } else {
                icon.className = 'fas fa-moon';
                icon.style.color = 'var(--gold)';
            }
        }

        // VIEW SWITCHER
        function switchView(viewName) {
            // Update Icons
            document.querySelectorAll('.nav-icon').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-icon[onclick="switchView('${viewName}')"]`).classList.add('active');

            // Update Sections
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`view-${viewName}`).classList.add('active');

            currentView = viewName;

            // Refresh content if needed
            if (viewName === 'feed') loadFeed();
            if (viewName === 'notifications') loadNotifications();
            if (viewName === 'messages') loadConversations();
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            if (sidebar.style.transform === 'translateX(0px)') {
                sidebar.style.transform = ''; sidebar.classList.remove('open');
            } else {
                sidebar.style.transform = 'translateX(0px)'; sidebar.classList.add('open');
            }
        }
        function nav(sectionId) { window.location.href = '/?page=' + sectionId; }


        // --- FEED LOGIC ---
        // --- FEED LOGIC ---
        let currentFeedPage = 1;
        let currentFollowingPage = 1; // New pagination var for following list
        let feedSearchTimer;
        let currentFeedSearch = '';

        async function loadFollowingList(reset = false) {
            const container = document.getElementById('wall-feed-container');
            const loadBtn = document.getElementById('feed-load-more');

            if (reset) {
                currentFollowingPage = 1;
                container.innerHTML = '<div style="text-align:center; padding:20px"><i class="fas fa-circle-notch fa-spin"></i> Yükleniyor...</div>';
                loadBtn.style.display = 'none';
            }

            try {
                const res = await fetch(`/interactive/api/following-list/?page=${currentFollowingPage}&q=${encodeURIComponent(currentFeedSearch)}`);
                const data = await res.json();

                if (reset || currentFollowingPage === 1) container.innerHTML = '';

                if (data.users.length === 0 && (reset || currentFollowingPage === 1)) {
                    container.innerHTML = '<div style="opacity:0.6; text-align:center; padding:20px">Sonuç bulunamadı.</div>';
                    loadBtn.style.display = 'none';
                    return;
                }

                // Show as User Cards
                data.users.forEach(u => {
                    const html = `
                    <div class="user-card" onclick="window.location.href='/interactive/user/${u.username}/'" style="cursor:pointer">
                         <div style="font-weight:bold; color:var(--text); display:flex; align-items:center; gap:10px">
                             <div class="avatar" style="width:30px; height:30px; font-size:0.9rem">${u.username[0].toUpperCase()}</div>
                             ${u.username}
                         </div>
                         <i class="fas fa-chevron-right" style="color:var(--text-muted)"></i>
                    </div>`;
                    container.innerHTML += html;
                });

                if (data.has_next) {
                    loadBtn.style.display = 'block';
                } else {
                    loadBtn.style.display = 'none';
                }

            } catch (e) {
                console.error(e);
                if (reset) container.innerHTML = '<div style="color:var(--accent); text-align:center">Liste yüklenemedi.</div>';
            }
        }

        function switchFeedTab(filter, el) {
            document.querySelectorAll('.feed-tabs .tab-item').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            feedFilter = filter;

            // Common Reset
            document.getElementById('feed-search').value = '';
            currentFeedSearch = '';

            // Show search for all tabs now!
            document.getElementById('feed-search').style.display = 'block';

            if (filter === 'following') {
                loadFollowingList(true);
            } else {
                loadFeed(true);
            }
        }

        function searchFeed() {
            clearTimeout(feedSearchTimer);
            feedSearchTimer = setTimeout(() => {
                const q = document.getElementById('feed-search').value.trim();
                currentFeedSearch = q;
                if (feedFilter === 'following') {
                    loadFollowingList(true);
                } else {
                    loadFeed(true);
                }
            }, 600);
        }

        function loadMorePosts() {
            if (feedFilter === 'following') {
                currentFollowingPage++;
                loadFollowingList(false);
            } else {
                currentFeedPage++;
                loadFeed(false);
            }
        }

        async function loadFeed(reset = false) {
            const container = document.getElementById('wall-feed-container');
            const loadBtn = document.getElementById('feed-load-more');

            if (reset) {
                currentFeedPage = 1;
                container.innerHTML = '<div style="text-align:center; padding:20px"><i class="fas fa-circle-notch fa-spin"></i> Yükleniyor...</div>';
                loadBtn.style.display = 'none';
            }

            const url = `/interactive/wall/api/posts/?filter=${feedFilter}&page=${currentFeedPage}&q=${encodeURIComponent(currentFeedSearch)}`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (reset || currentFeedPage === 1) container.innerHTML = '';

                if (data.posts.length === 0 && (reset || currentFeedPage === 1)) {
                    container.innerHTML = '<div style="opacity:0.6; text-align:center; padding:20px">Henüz gönderi yok veya sonuç bulunamadı.</div>';
                    loadBtn.style.display = 'none';
                    return;
                }

                data.posts.forEach(p => {
                    const isLong = p.content.length > 200;
                    const shortContent = isLong ? p.content.substring(0, 200) + '...' : p.content;
                    const fullContent = p.content.replace(/"/g, '&quot;'); // Escape for safety in attribute if needed, but here we toggle classes

                    const html = `
                    <div class="wall-card">
                        <div class="post-header">
                            <div class="avatar" onclick="window.location.href='/interactive/user/${p.user}/'">${p.user[0].toUpperCase()}</div>
                            <div>
                                <div style="font-weight:bold; color:var(--gold); cursor:pointer" onclick="window.location.href='/interactive/user/${p.user}/'">${p.user}</div>
                                <div style="font-size:0.8rem; opacity:0.6">${p.created_at}</div>
                            </div>
                        </div>
                        <div class="post-content" id="post-content-${p.id}">
                            <span class="short-text">${shortContent}</span>
                            <span class="full-text" style="display:none">${p.content}</span>
                            ${isLong ? `<a href="#" onclick="togglePost(event, ${p.id}); return false;" style="color:var(--accent); font-size:0.9rem; margin-left:5px">Devamını Oku</a>` : ''}
                        </div>
                    </div>`;
                    container.innerHTML += html;
                });

                // Handle Load More visibility
                if (data.has_next) {
                    loadBtn.style.display = 'block';
                } else {
                    loadBtn.style.display = 'none';
                }

            } catch (e) {
                console.error(e);
                if (reset) container.innerHTML = '<div style="color:var(--accent); text-align:center">Yüklenirken hata oluştu.</div>';
            }
        }

        function togglePost(e, id) {
            const container = document.getElementById(`post-content-${id}`);
            const short = container.querySelector('.short-text');
            const full = container.querySelector('.full-text');
            const btn = e.target;

            if (full.style.display === 'none') {
                short.style.display = 'none';
                full.style.display = 'inline';
                btn.innerText = 'Daha Az Göster';
            } else {
                short.style.display = 'inline';
                full.style.display = 'none';
                btn.innerText = 'Devamını Oku';
            }
        }


        async function sendPost() {
            const txt = document.getElementById('post-content');
            if (!txt.value.trim()) return;
            const res = await fetch('/interactive/wall/api/create/', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ content: txt.value })
            });
            if ((await res.json()).success) {
                txt.value = '';
                loadFeed(true);
                // If on specific tab, switch to all? No need.
            }
        }


        // --- EXPLORE LOGIC ---
        let debounceTimer;
        function searchUsers() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                const q = document.getElementById('search-input').value;
                if (q.length < 2) return;
                const res = await fetch(`/interactive/api/search-users/?q=${q}`);
                const data = await res.json();
                const area = document.getElementById('explore-results');
                area.innerHTML = '';
                if (data.users.length === 0) { area.innerHTML = '<div style="text-align:center;opacity:0.6">Bulunamadı.</div>'; return; }

                data.users.forEach(u => {
                    area.innerHTML += `
                    <div class="user-card" style="cursor:default">
                         <div style="display:flex; align-items:center; cursor:pointer" onclick="window.location.href='/interactive/user/${u.username}/'">
                            <div class="avatar" style="width:40px;height:40px;margin-right:10px">${u.username[0].toUpperCase()}</div>
                            <strong>${u.username}</strong>
                         </div>
                         <div style="display:flex; gap:10px; align-items:center">
                             <button class="btn-small ${u.is_following ? 'active' : ''}" onclick="toggleFollowFromSearch(this, '${u.username}')">
                                ${u.is_following ? 'Takibi Bırak' : 'Takip Et'}
                             </button>
                             <button style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:1.2rem" onclick="openChatFromSearch('${u.username}')">
                                <i class="fas fa-envelope"></i>
                             </button>
                         </div>
                    </div>`;
                });
            }, 500);
        }

        async function toggleFollowFromSearch(btn, username) {
            btn.disabled = true;
            try {
                const res = await fetch('/interactive/api/follow/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: username })
                });
                const d = await res.json();
                if (d.status) {
                    if (d.status === 'followed') {
                        btn.innerText = 'Takibi Bırak';
                        btn.classList.add('active');
                    } else if (d.status === 'unfollowed') {
                        btn.innerText = 'Takip Et';
                        btn.classList.remove('active');
                    }
                }
            } catch (e) { console.error(e); }
            finally { btn.disabled = false; }
        }

        function openChatFromSearch(username) {
            switchView('messages');
            openChat(username);
        }

        // --- MESSAGES LOGIC ---
        async function loadConversations() {
            const res = await fetch('/interactive/api/messages/conversations/');
            const data = await res.json();
            const list = document.getElementById('conv-list');
            list.innerHTML = '';
            data.conversations.forEach(c => {
                const item = document.createElement('div');
                item.className = `conv-item ${activeChatUser === c.username ? 'active' : ''}`;
                item.onclick = () => openChat(c.username);
                item.innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-weight:bold">
                        <span>${c.username}</span>
                        <span style="font-size:0.7rem; opacity:0.6; font-weight:normal">${c.timestamp}</span>
                    </div>
                    <div style="font-size:0.8rem; opacity:0.6; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${c.last_message || '...'}</div>
                `;
                list.appendChild(item);
            });
        }

        async function openChat(username) {
            activeChatUser = username;
            document.getElementById('chat-empty-state').style.display = 'none';
            document.getElementById('chat-ui-container').style.display = 'flex'; // flex for col layout
            document.getElementById('chat-partner-name').innerText = username;

            // Highlight nav
            loadConversations(); // to set active class

            const res = await fetch(`/interactive/api/messages/${username}/`);
            const data = await res.json();
            const box = document.getElementById('msg-box');
            box.innerHTML = '';

            data.messages.forEach(m => {
                const d = document.createElement('div');
                d.className = `message-bubble ${m.is_me ? 'msg-sent' : 'msg-received'}`;
                d.innerText = m.body;
                box.appendChild(d);
            });
            box.scrollTop = box.scrollHeight;
        }

        async function sendMessage() {
            const inp = document.getElementById('msg-input');
            const body = inp.value.trim();
            if (!body || !activeChatUser) return;

            // Visual feedback
            const btn = document.querySelector('.chat-input-area button');
            const originalBtnContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                const res = await fetch('/interactive/api/messages/send/', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ to: activeChatUser, body: body })
                });

                if (!res.ok) throw new Error(`Sunucu hatası: ${res.status}`);

                const d = await res.json();
                if (d.success) {
                    inp.value = '';
                    openChat(activeChatUser);
                } else {
                    alert('Mesaj gönderilemedi: ' + (d.error || 'Bilinmeyen hata'));
                }
            } catch (err) {
                console.error(err);
                alert('Hata: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnContent;
                inp.focus();
            }
        }

        // Event listener for input
        document.getElementById('msg-input').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') sendMessage();
        });

        function visitProfile() {
            if (activeChatUser) window.location.href = `/interactive/user/${activeChatUser}/`;
        }

        // --- NOTIFICATIONS LOGIC ---
        let notifPage = 1;

        async function loadNotifications(reset = false) {
            const list = document.getElementById('notif-list');
            const loadBtn = document.getElementById('notif-load-more');

            if (reset) {
                notifPage = 1;
                list.innerHTML = '<div style="text-align:center; padding:20px"><i class="fas fa-circle-notch fa-spin"></i> Yükleniyor...</div>';
                loadBtn.style.display = 'none';
            }

            try {
                const res = await fetch(`/interactive/api/inbox/?page=${notifPage}`);
                const data = await res.json();

                if (reset || notifPage === 1) list.innerHTML = '';

                if (data.notifications.length === 0 && (reset || notifPage === 1)) {
                    list.innerHTML = '<div style="text-align:center; opacity:0.6; margin-top:20px">Yeni bildirim yok.</div>';
                    loadBtn.style.display = 'none';
                    return;
                }

                data.notifications.forEach(n => {
                    const html = `
                    <div class="msg-card ${n.is_read ? 'read' : ''}" onclick="markSingleRead(${n.id}, '${n.title}', this)">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px">
                            <span style="font-weight:bold; color:var(--gold)">${n.title}</span>
                            <span style="font-size:0.7rem; opacity:0.6">${n.date}</span>
                        </div>
                        <div>${n.message}</div>
                    </div>`;
                    list.innerHTML += html;
                });

                if (data.has_next) {
                    loadBtn.style.display = 'block';
                } else {
                    loadBtn.style.display = 'none';
                }

            } catch (e) { console.error(e); }
        }

        function loadMoreNotifs() {
            notifPage++;
            loadNotifications(false);
        }

        async function markSingleRead(id, title, el) {
            // Optimistic UI update
            el.classList.add('read');
            el.style.opacity = '0.6';
            el.style.borderLeftColor = 'var(--border)';

            // Call API to mark as read (need to impl endpoint or use existing logic)
            // For now, we reuse the mark-read logic or create a new one?
            // Actually, let's create a specific one or just ignore backend update if not granular.
            // Wait, standard inbox/mark-read/ marks ALL. We need a single one.
            // Since User didn't ask for backend granularity explicitly but "okundu olmalı", let's assume UI first.
            // BUT, if we have a "Yeni Mesaj" logic, we should open chat.

            if (title.includes('Yeni Mesaj')) {
                const parts = title.split(':');
                if (parts.length > 1) {
                    const usernames = parts[1].trim();
                    // Switch to messages and open chat
                    switchView('messages');
                    openChat(usernames);
                }
            }

            // Send request to mark valid
            await fetch(`/interactive/inbox/mark-single/${id}/`, { method: 'POST' });
            updateUnreadCount();
        }

        async function markAllRead() {
            await fetch('/interactive/inbox/mark-read/', { method: 'POST' });
            loadNotifications();
        }

        // Polling for functionality
        setInterval(() => {
            if (currentView === 'messages' && activeChatUser) {
                // simple poll implementation - ideally optimize
                openChat(activeChatUser);
            }
            updateUnreadCount(); // Poll nav badge too
        }, 5000); // Check every 5s

        async function updateUnreadCount() {
            try {
                const res = await fetch('/interactive/api/inbox/');
                if (res.ok) {
                    const data = await res.json();
                    const unread = data.notifications.filter(n => !n.is_read).length;
                    const badge = document.getElementById('global-unread-count');
                    if (badge) {
                        if (unread > 0) {
                            badge.innerText = unread > 9 ? '9+' : unread;
                            badge.style.display = 'flex';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }
            } catch (e) { }
        }

        // Initial check
        updateUnreadCount();


    </script>
</body>

</html>