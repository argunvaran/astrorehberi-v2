<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <title>Kozmik EditÃ¶r</title>
    <!-- Simple CDN for a Rich Text Editor (Quill.js) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body {
            background: #1a0b2e;
            color: white;
            font-family: sans-serif;
            padding: 20px;
        }

        .editor-container {
            background: white;
            color: black;
            height: 300px;
            border-radius: 8px;
        }

        .btn {
            padding: 10px 20px;
            background: #E94560;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
            margin-top: 20px;
            font-size: 1rem;
        }

        h1 {
            color: gold;
        }
    </style>
</head>

<body>
    <h1>ðŸŒŸ Kozmik Ä°Ã§erik EditÃ¶rÃ¼</h1>
    <p>HaftalÄ±k genel burÃ§ yorumunu buradan girip yayÄ±nlayabilirsiniz.</p>

    <div style="margin-bottom:20px">
        <input type="text" id="post-title" placeholder="BaÅŸlÄ±k (Ã–rn: 24-30 Ocak HaftasÄ±)"
            style="width:100%; padding:10px; border-radius:5px; border:none; margin-bottom:10px">
        <input type="file" id="post-image" accept="image/*" style="color:white; margin-bottom:10px">
        <br>
        <span style="font-size:0.8rem; color: #aaa;">YayÄ±n Tarihi (Opsiyonel):</span>
        <input type="datetime-local" id="post-date"
            style="margin-bottom:10px; padding:5px; border-radius:5px; border:none;">
    </div>

    <!-- Create the editor container -->
    <div id="editor" class="editor-container"></div>

    <button class="btn" onclick="saveContent()">YAYINLA</button>

    <div id="status" style="margin-top:20px; color: yellow;"></div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        var quill = new Quill('#editor', {
            theme: 'snow',
            placeholder: 'YÄ±ldÄ±zlarÄ±n mesajÄ±nÄ± buraya yazÄ±n...'
        });

        async function saveContent() {
            const content = quill.root.innerHTML;
            const title = document.getElementById('post-title').value;
            /* Add Date Retrieval */
            const dateVal = document.getElementById('post-date') ? document.getElementById('post-date').value : '';

            if (!title) { alert("BaÅŸlÄ±k giriniz."); return; }

            document.getElementById('status').innerText = "Kaydediliyor...";


            console.log("DEBUG: Date Val being sent:", dateVal);

            const formData = new FormData();
            formData.append('title', title);
            formData.append('content', content);
            formData.append('published', 'true');
            if (dateVal) {
                formData.append('date', dateVal);
            }

            const fileInput = document.getElementById('post-image');
            if (fileInput && fileInput.files[0]) {
                formData.append('image', fileInput.files[0]);
            }

            try {
                const res = await fetch('/cms/save/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: formData
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('status').innerText = "âœ… BaÅŸarÄ±yla YayÄ±nlandÄ±! Ana sayfada gÃ¶rÃ¼necek.";
                } else {
                    document.getElementById('status').innerText = "Hata: " + data.error;
                }
            } catch (e) {
                document.getElementById('status').innerText = "Sunucu HatasÄ±";
            }
        }

        // CSRF Helper
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    </script>
</body>

</html>